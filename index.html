<!DOCTYPE html>
<html lang="en">
<!--
  SOVERNX ECA Demo ‚Äî Change Tracker
  ----------------------------------
  APP_VERSION: v4.1.1
  APP_BUILD: 2025-11-12
  CHANGELOG: This file contains a runtime-change tracker and a persisted changelog stored in localStorage under key 'SOV_CHANGELOG'.
  Usage: Click the 'Version' button in the header to view or append changelog entries. The file also exposes APP_VERSION and a persisted changelog for audit and tracking.
-->
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SOVERNX ‚Ä¢ ECA Transaction Demo v4.1.1 (Classic UI + Dashboard)</title>
<style>
  .nav-tab-active{
    border-bottom:2px solid var(--gold);
    box-shadow:0 0 0 1px rgba(212,175,55,0.4);
  }

  :root{
    --bg:#0a122b;--card:#0f1941;--muted:#1b2450;--gold:#d4af37;--text:#f2f2f2;
    --amber:#ffb020;--green:#30d07f;--blue:#12b0a2;--ink:#cfe7ff;--grey:#6b7280;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1160px;margin:0 auto;padding:16px}
  h1{color:var(--gold);margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:12px;padding:12px;margin-top:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#111a47;border:1px solid #33408a;color:#e8ecff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-step{min-width:260px}
  .state-idle{background:#1f2937;border-color:#374151}
  .state-progress{background:#5b3f00;border-color:#ad7a00;color:#fff5e5}
  .state-done{background:#0e5c38;border-color:#17a86f;color:#eafff5}
  .progress{height:6px;background:#101a45;border:1px solid #1b2450;border-radius:8px;overflow:hidden}
  .progress>div{height:100%;background:var(--blue);width:0%}
  .timeline{display:flex;gap:8px;flex-wrap:wrap}
  .step{flex:1 1 170px;background:#0d1640;border:1px solid #1b2450;border-radius:10px;padding:8px}
  .step.active{outline:2px solid var(--amber)}
  .step.done{outline:2px solid var(--green)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px 8px;border-bottom:1px solid #1b2450}
  td a.hash{color:var(--ink);text-decoration:underline;cursor:pointer}
  .doclink{display:block;color:#cfe7ff;text-decoration:underline;margin:4px 0}
  .action,.sub,.json,.dash{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:999}
  .inner{background:#0b1333;border:1px solid #1b2450;border-radius:14px;width:min(980px,94vw);max-height:90vh;overflow:auto;padding:14px}
  .qr-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:3500}
  .qr-inner{background:#0b1333;border:2px solid var(--gold);border-radius:14px;padding:24px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.5);position:relative}
  .qr-inner h2{color:var(--gold);margin:0 0 8px;font-size:18px}
  .qr-inner p{color:var(--ink);opacity:0.85;margin:0 0 16px;font-size:13px}
  .qr-inner canvas{border:2px solid var(--gold);border-radius:8px;background:#fff;display:block;margin:0 auto}
  .qr-inner .hint-text{color:var(--grey);font-size:12px;margin-top:12px;line-height:1.4}
  .qr-close-btn{position:absolute;top:16px;right:16px;background:var(--gold);color:var(--bg);border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;font-weight:bold}
  .qr-close-btn:hover{background:#ffcb69;opacity:0.9}
  .progressbar{height:10px;background:#13265c;border:1px solid #1e2a56;border-radius:8px;overflow:hidden}
  .progressbar>div{height:100%;background:var(--blue);width:0%}
  .fld{margin:6px 0} .fld label{display:block;margin-bottom:4px;font-size:13px;opacity:.9}
  .fld input{width:100%;max-width:440px;background:#0c1436;border:1px solid #263471;color:#e8ecff;border-radius:8px;padding:6px 8px}
  .fld input[type="checkbox"]{width:auto}
  .fld input[type="file"]{padding:8px;cursor:pointer}
  #err{position:fixed;right:10px;bottom:10px;max-width:460px;background:#290b0b;color:#ffdcdc;border:1px solid #5c1a1a;border-radius:10px;padding:10px;display:none;z-index:2000}
  #err pre{white-space:pre-wrap;font-size:12px;margin:6px 0 0}
  .hint{opacity:.7;font-size:12px}
  .pill{padding:4px 8px;border:1px solid var(--muted);border-radius:999px;opacity:.9}
  .insights{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:8px}
  .insights .k{background:#0c1537;border:1px solid #1c2a63;border-radius:10px;padding:8px}
  .k b{display:block;color:var(--ink);font-size:13px;margin-bottom:6px}
  .rolepick select{background:#0c1436;border:1px solid #263471;color:#e8ecff;border-radius:8px;padding:6px 8px}
  .badge{font-size:12px;padding:2px 6px;border-radius:8px;border:1px solid var(--muted)}
  .b-grey{background:#0f1a41;color:#9aa3b2}
  .b-amber{background:#5b3f00;color:#ffe8b0}
  .b-green{background:#0e5c38;color:#eafff5}
  /* Multi-window processing display */
  .proc-windows{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:12px 0}
  .proc-window{background:#0c1537;border:2px solid var(--gold);border-radius:10px;padding:12px;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
  .proc-window h3{color:var(--gold);margin:0 0 8px;font-size:13px}
    /* SVG-based circular progress spinner */
    .proc-spinner-container{position:relative;width:70px;height:70px;margin:8px auto;display:flex;align-items:center;justify-content:center}
    .proc-spinner-svg{width:100%;height:100%;transform:rotate(-90deg)}
    .proc-spinner-bg{fill:none;stroke:var(--amber);stroke-width:5;opacity:0.3}
    .proc-spinner-progress{fill:none;stroke:var(--gold);stroke-width:5;stroke-dasharray:188;stroke-dashoffset:188;transition:stroke-dashoffset 0.3s linear,stroke 0.5s ease;stroke-linecap:round}
    .proc-spinner-progress.complete{stroke:var(--green)}
    .proc-spinner-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:14px;font-weight:bold;color:var(--gold);width:70px;text-align:center}
    .proc-spinner-text.complete{color:var(--green)}
  .proc-window .proc-stat{font-size:12px;color:var(--ink);margin:6px 0;font-weight:600}
  .proc-window .proc-items{font-size:11px;color:var(--grey);margin-top:6px;line-height:1.3}
/* proc spinner styles */
.proc-spinner { position: relative; width: 80px; height: 80px; margin: 4px auto; }
.proc-spinner svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.proc-spinner .proc-bg { fill:none; stroke:#33427a; stroke-width:8; opacity:0.35; }
.proc-spinner .proc-spinner-progress { fill:none; stroke:#d4af37; stroke-width:8; stroke-linecap:round;
  stroke-dasharray:188; stroke-dashoffset:188; transition: stroke .25s ease; }
.proc-spinner .proc-pct { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
  font-weight:700; font-size:14px; color:#d4af37; }
.proc-spinner-progress.complete { stroke:#30d07f !important; }
.proc-pct.complete { color:#30d07f !important; }

/* User section highlighting after sign-in */
.user-section-highlight {
  box-shadow: 0 0 16px rgba(212, 175, 55, 0.7), inset 0 0 8px rgba(212, 175, 55, 0.2) !important;
  border-color: var(--gold) !important;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(212, 175, 55, 0.02)) !important;
  animation: highlight-pulse 2s ease-in-out;
}
@keyframes highlight-pulse {
  0%, 100% { box-shadow: 0 0 16px rgba(212, 175, 55, 0.7), inset 0 0 8px rgba(212, 175, 55, 0.2); }
  50% { box-shadow: 0 0 24px rgba(212, 175, 55, 0.9), inset 0 0 12px rgba(212, 175, 55, 0.3); }
}

  /* === Comfort Pack (demo protection) === */
  body.sx-demo-locked #app-wrap, body.sx-demo-locked #iam-topbar { filter: blur(2px); pointer-events:none; user-select:none; }
  body.sx-demo-locked #sx-demo-license-backdrop { display:flex; }
  body.sx-auth-locked #main-nav, body.sx-auth-locked [data-section], body.sx-auth-locked .timeline, body.sx-auth-locked .buttons { opacity:.35; pointer-events:none; }
  #sx-watermark { position: fixed; right: 10px; bottom: 10px; z-index: 99997; background: rgba(10,16,40,.75); color:#cfe7ff; border:1px solid #26357a; padding:8px 10px; border-radius:10px; font: 12px/1.35 system-ui,-apple-system,Segoe UI,Roboto; max-width: 52vw; }
  #sx-watermark b { color:#fff; }
  #sx-demo-license-backdrop { position: fixed; inset:0; background: rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index: 99999; }
  #sx-demo-license { width: min(720px, 92vw); max-height: 86vh; overflow:auto; background:#0f1a44; color:#eaf2ff; border:1px solid #2b3a86; border-radius: 14px; box-shadow: 0 14px 40px rgba(0,0,0,.65); padding: 18px 18px 14px; }
  #sx-demo-license h2 { margin: 0 0 10px 0; font-size: 18px; }
  #sx-demo-license .small { font-size: 12px; opacity:.9; }
  #sx-demo-license ul { margin: 8px 0 10px 18px; }
  #sx-demo-license .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  #sx-demo-license .actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 10px; }
  #sx-demo-license .danger { color:#ffd6d6; }
</style>

<!-- SOVERNX IAM/Gateway demo styles -->
<style>
  .hidden { display: none !important; }
  .iam-topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
    display: flex; align-items: center; justify-content: space-between;
    background: #0c1537; color: #cfe7ff; padding: 6px 10px;
    border-bottom: 1px solid #1c2a63; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto;
  }
  .iam-topbar .left { display: flex; gap: 10px; align-items: center; }
  .iam-topbar .right { display: flex; gap: 8px; align-items: center; }
  .iam-chip { background:#142255; border:1px solid #1c2a63; padding:2px 6px; border-radius:6px; }
  .iam-btn { background:#20316f; color:#fff; border:1px solid #3b4aa1; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .iam-btn:disabled { opacity:0.6; cursor:not-allowed; }
  .iam-modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index: 99998;
  }
  .iam-modal { width: 420px; background: #0f1a44; color: #eaf2ff; border:1px solid #2b3a86; border-radius: 12px; 
               box-shadow: 0 10px 30px rgba(0,0,0,0.6); padding: 16px 16px 12px; }
  .iam-modal h3 { margin: 0 0 12px 0; font-weight: 700; }
  .iam-row { margin: 8px 0; display:flex; gap:8px; }
  .iam-row label { width: 120px; }
  .iam-row input, .iam-row select, .iam-row textarea { flex:1; background:#0b1333; color:#eaf2ff; border:1px solid #33427a; border-radius:8px; padding:6px 8px; }
  .iam-note { font-size: 12px; opacity: 0.85; }
  .iam-actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 10px; }
  .iam-banner-spacer { height: 42px; }
</style>

</head>
<body class="sx-demo-locked sx-auth-locked">

<div id="sx-demo-license-backdrop" aria-hidden="false">
  <div id="sx-demo-license" role="dialog" aria-modal="true">
    <h2>Demo Licence & Confidentiality Notice</h2>
    <div class="small">This SOVERNX simulator is provided for <b>demonstration and evaluation</b> only. It represents proprietary workflow concepts, governance logic, and presentation IP.</div>
    <ul class="small">
      <li><b>No commercial use</b>, copying, reverse engineering, or redistribution without written authorisation.</li>
      <li>This demo contains <b>no live funds</b>, no live guarantees, and no production chain; all outputs are simulated.</li>
      <li>Any access is logged locally in the <b>Audit Ledger</b> for accountability.</li>
    </ul>
    <div class="row small" style="margin-top:10px;">
      <label><input type="checkbox" id="sx-demo-accept" /> I acknowledge and accept the Demo Licence terms.</label>
    </div>
    <div class="actions">
      <button class="iam-btn" id="sx-demo-view" type="button">View Terms</button>
      <button class="iam-btn" id="sx-demo-continue" type="button" disabled>Continue</button>
    </div>
    <div class="small" style="margin-top:10px; opacity:.85">Tip: For client meetings, open over HTTPS (e.g., GitHub Pages) to avoid iPad file restrictions.</div>
  </div>
</div>

<div id="sx-watermark" class="hidden"></div>


<div class="iam-topbar" id="iam-topbar">
  <div class="left">
    <div class="iam-chip" id="iam-version">SOVERNX v4.1.2 ¬∑ </div>
    <div class="iam-chip hidden" id="iam-user"></div>
    <div class="iam-chip hidden" id="iam-roles"></div>
  </div>
  <div class="right">
    <button class="iam-btn" id="iam-login-btn">Sign In</button>
    <button class="iam-btn hidden" id="iam-logout-btn">Sign Out</button>
  </div>
</div>
<div class="iam-banner-spacer"></div>

<div id="version-banner" class="version-tag" style="padding:6px 10px;margin:0 0 10px 0;background:#0c1537;border-bottom:1px solid #1c2a63;color:#cfe7ff;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto;"></div>
<div class="wrap" id="app-wrap">
  <h1 id="app-title">SOVERNX ‚Äî ECA Transaction Simulation </h1>
  <div id="prelogin-message" class="card" style="margin-top:10px;">
    <div style="font-size:14px;line-height:1.5;">
      <b>Welcome to SOVERNX.</b> Please sign in using the IAM bar above to access project dashboards, reporting, administration and the full ECA transaction simulation.
    </div>
  </div>

  <div class="card main-nav" id="main-nav" data-requires="">
    <div class="row" style="gap:8px;flex-wrap:wrap;">
      <button class="btn nav-tab" data-target="DASHBOARDS">Dashboards</button>
      <button class="btn nav-tab" data-target="REPORTING">Reporting</button>
      <button class="btn nav-tab" data-target="ADMIN">Administration</button>
      <button class="btn nav-tab" data-target="SIMULATION">Simulation</button>
    </div>
  </div>


  <div class="card" data-section="DASHBOARDS SIMULATION">

    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:12px">
        <div class="rolepick"><span title="Linked to IAM login role">Role:</span>
          <select id="role">
            <option value="ALL">All</option>
            <option value="SPONSOR">SPONSOR</option>
            <option value="AUDIT">AUDIT</option>
            <option value="ECA">ECA</option>
            <option value="BANK">BANK</option>
            <option value="TREASURY">TREASURY</option>
            <option value="PLATFORM">PLATFORM</option>
            <option value="CONTRACTOR">CONTRACTOR</option>
            <option value="MINISTRY">MINISTRY</option>
          </select>
        </div>
        <div class="pill">Approvals: <b id="p-approvals">0 / 12</b></div>
        <div class="pill">Saved: <b id="saveState">‚Äî</b></div>
      </div>
      <div class="row">
        <button class="btn" id="btnDash">Dashboard</button>
        <button class="btn" id="btnNotifAudit">Notifications Audit</button>
        <button class="btn" id="btnSave">Save</button>
        <button class="btn" id="btnLoad">Load</button>
        <button class="btn" id="btnCSV">Export CSV</button>
        <button class="btn" id="btnVersion">Version</button>
        <button class="btn" onclick="location.reload()">Reset</button>
      </div>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div><b id="p-title">Project (not set)</b><div id="p-meta" style="opacity:.8">Name / Value / Tenor / Risk / Country</div></div>
      <div class="hint">üîê IAM login auto-syncs role ‚Ä¢ Only relevant sections show per signed-in actor ‚Ä¢ Project must be created before later steps become available</div>
    </div>

    <div class="timeline" style="margin-top:8px">
      <div class="step" data-step="CREATE" data-role="SPONSOR"><b>1. Create Project</b></div>
  <div class="step" data-step="DOCS" data-role="AUDIT"><b>2. Data Room</b></div>
      <div class="step" data-step="INTERFACE" data-role="ECA"><b>3. Interface</b></div>
  <div class="step" data-step="ENGINE" data-role="PLATFORM"><b>4. Project Due Dilligence</b></div>
  <div class="step" data-step="DD_OUT" data-role="AUDIT"><b>5. DD Outputs</b></div>
      <div class="step" data-step="ECA_PRICING" data-role="ECA"><b>6. ECA/ECIC</b></div>
      <div class="step" data-step="POLICY_OUT" data-role="ECA"><b>7. Policy & Slip</b></div>
      <div class="step" data-step="CREDIT_COMMITTEE" data-role="BANK"><b>8. Bank/DFI</b></div>
      <div class="step" data-step="FACILITY" data-role="BANK"><b>9. Facility</b></div>
      <div class="step" data-step="TREASURY" data-role="TREASURY"><b>10. Treasury</b></div>
  <div class="step" data-step="PAYMENT_PACK" data-role="MINISTRY"><b>11. Ministry: Payment Pack</b></div>
      <div class="step" data-step="CONTRACTOR" data-role="CONTRACTOR"><b>12. CONTRACTOR: Fulfillment of Project</b></div>
    </div>
    <div class="progress" style="margin-top:8px"><div id="bar"></div></div>
  </div>

  <div class="card" data-section="SIMULATION">
    <div class="row buttons">
  <button class="btn btn-step state-idle" id="btn1" data-role="SPONSOR">1) SPONSOR: Create Project</button>
  <button class="btn btn-step state-idle" id="btn2" data-role="AUDIT" disabled>2) AUDIT: Confirm Data Room</button>
  <button class="btn btn-step state-idle" id="btn3" data-role="ECA" disabled>3) ECA: Project Interface</button>
  <button class="btn btn-step state-idle" id="btn4" data-role="PLATFORM" disabled>4) PLATFORM: Project Due Dilligence</button>
  <button class="btn btn-step state-idle" id="btn5" data-role="AUDIT" disabled>5) AUDIT: Generate DD Outputs</button>
      <button class="btn btn-step state-idle" id="btn6" data-role="ECA" disabled>6) ECA: Pricing & Reinsurance</button>
      <button class="btn btn-step state-idle" id="btn7" data-role="ECA" disabled>7) ECA: Policy Draft & Slip</button>
      <button class="btn btn-step state-idle" id="btn8" data-role="BANK" disabled>8) BANK: Credit Committee</button>
      <button class="btn btn-step state-idle" id="btn9" data-role="BANK" disabled>9) BANK: Facility & LC/Guarantee</button>
      <button class="btn btn-step state-idle" id="btn10" data-role="TREASURY" disabled>10) TREASURY: Issue Sovereign Guarantee</button>
  <button class="btn btn-step state-idle" id="btn11" data-role="MINISTRY" disabled>11) MINISTRY: Payment Pack</button>
  <button class="btn btn-step state-idle" id="btn12" data-role="CONTRACTOR" disabled>12) CONTRACTOR: Fulfillment of Project</button>
    </div>
    <div id="docs"></div>
  </div>

  <div class="card" data-section="REPORTING SIMULATION">
    <div class="row" style="justify-content:space-between;align-items:center">
      <b>Audit Ledger</b>
      <div class="insights">
        <div class="k"><b>Stage</b><div id="ins_stage">‚Äî</div></div>
        <div class="k"><b>Approvals</b><div id="ins_appr">0</div></div>
        <div class="k"><b>Prem. Est.</b><div id="ins_prem">‚Äî</div></div>
        <div class="k"><b>Reins Placed</b><div id="ins_reins">‚Äî</div></div>
        <div class="k"><b>Headroom</b><div id="ins_head">‚Äî</div></div>
        <div class="k"><b>Docs</b><div id="ins_docs">0</div></div>
      </div>
    </div>
    <table id="tbl"><thead><tr><th>#</th><th>Time</th><th>Actor</th><th>Action</th><th>Details</th><th>Hash</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- Action modal -->
<div id="action" class="action" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b id="act-title">Action</b>
    <div class="row">
      <button class="btn" id="act-force">Force Submit</button>
      <button class="btn" onclick="closeAction()">Cancel</button>
    </div>
  </div><hr style="border-color:#1b2450">
  <div id="act-body"></div>
  <div class="progressbar" style="margin-top:8px"><div id="act-bar"></div></div>
  <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="act-submit" disabled>Submit</button></div>
</div></div>

<!-- Sub modal (risk, pricing, reins) -->
<div id="sub" class="sub" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b id="sub-title">Sub‚Äëprocess</b><button class="btn" onclick="closeSub(false)">Close</button>
  </div><hr style="border-color:#1b2450">
  <div id="sub-body"></div>
  <div class="progressbar" style="margin-top:8px"><div id="sub-bar"></div></div>
  <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" id="sub-accept" disabled>Accept</button></div>
</div></div>

<!-- JSON ledger modal -->
<div id="json" class="json" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>On‚Äëchain block view</b><button class="btn" onclick="closeJSON()">Close</button>
  </div><hr style="border-color:#1b2450">
  <pre id="json-pre" style="white-space:pre-wrap;font:13px ui-monospace,Consolas,monospace;color:#cfe7ff"></pre>
</div></div>

<!-- Dashboard modal -->
<div id="dash" class="dash" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>Stakeholder Dashboard ‚Äî Project Status</b>
    <div class="row">
      <button class="btn" id="btnStakeReport">Generate Collated Report (PDF)</button>
      <button class="btn" onclick="closeDash()">Close</button>
    </div>
  </div><hr style="border-color:#1b2450">
  <div id="dash-body"></div>
</div></div>

<!-- Notifications Audit Dashboard modal -->
<div id="notif-audit" class="dash" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center">
    <b>Notifications Audit Dashboard</b>
    <div class="row">
      <button class="btn" onclick="exportNotificationAudit()">Export Audit (JSON)</button>
      <button class="btn" onclick="closeNotifAudit()">Close</button>
    </div>
  </div><hr style="border-color:#1b2450">
  <div id="notif-audit-body" style="font-size:13px"></div>
</div></div>

<!-- QR Code Overlay -->
<div id="qr-overlay" class="qr-overlay">
  <div class="qr-inner">
    <button class="qr-close-btn" onclick="closeQROverlay()">√ó</button>
    <h2 id="qr-title">Block Reference</h2>
    <p id="qr-desc">Scan with a QR scanner to view or link to this block</p>
    <canvas id="qr-canvas" width="300" height="300"></canvas>
    <div class="hint-text">
      <div id="qr-hash" style="font-family:monospace;margin-top:8px;opacity:0.7">Hash: ‚Äî</div>
      <div style="margin-top:8px">Link: <span style="font-family:monospace" id="qr-link">‚Äî</span></div>
    </div>
  </div>
</div>

<div id="err"><b>Runtime error</b><pre id="err-pre"></pre></div>

<script>
(function(){
  function initializeProcessingSpinners(root, duration=5000){
    try{
      const scope = root || document;
      const spinners = scope.querySelectorAll('.proc-spinner-progress');
      if(spinners.length === 0) return;
      const startTime = Date.now();
      const maxOffset = 188; // 2œÄr where r=30
      function animate(){
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const pct = Math.round(progress * 100);
        spinners.forEach(spinner => {
          const pctElem = scope.querySelector('#' + spinner.id + '-text');
          spinner.style.strokeDashoffset = (maxOffset * (1 - progress)).toFixed(2);
          if (pctElem) pctElem.textContent = pct + '%';
          if (progress >= 1) {
            spinner.classList.add('complete');
            if (pctElem) pctElem.classList.add('complete');
          }
        });
        if (progress < 1) requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }catch(e){ console.warn('initializeProcessingSpinners error:', e); }
  }
  function titleMatchesSection6(title){
    const t = (title || '').toLowerCase();
    return t.includes('risk') || t.includes('pricing');
  }

  const wrapOpenSub = () => {
    if (typeof window.openSub === 'function' && !window.openSub.__sxWrapped) {
      const _openSub = window.openSub;
      window.openSub = function(title, body, duration){
        const ret = _openSub.apply(this, arguments);
        if (titleMatchesSection6(title)) {
          setTimeout(() => {
            const modal = document.querySelector('.modal.show, .modal[open], .modal[style*="display: block"]') || document;
            initializeProcessingSpinners(modal, Math.max(duration || 3000, 1200));
          }, 60);
        }
        return ret;
      };
      window.openSub.__sxWrapped = true;
    }
  };
  wrapOpenSub();
  const int = setInterval(()=>{
    wrapOpenSub();
    if (window.openSub && window.openSub.__sxWrapped) clearInterval(int);
  }, 200);
  const mo = new MutationObserver(() => {
    const activeModal = document.querySelector('.modal.show, .modal[open], .modal[style*="display: block"]');
    if (activeModal && activeModal.querySelector('.proc-spinner-progress')) {
      initializeProcessingSpinners(activeModal, 3000);
    }
  });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();


const $=q=>document.querySelector(q); const $$=q=>Array.from(document.querySelectorAll(q));
function demoHash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=(h*16777619)>>>0; } return ("00000000"+(h>>>0).toString(16)).slice(-8); }
function showErr(e){ const el=document.getElementById('err'); el.style.display='block'; document.getElementById('err-pre').textContent=String(e&&e.stack||e); }
function setBtn(el, cls){ el.classList.remove('state-idle','state-progress','state-done'); el.classList.add(cls); }
function stepActive(key){ $$('.step').forEach(s=>s.classList.remove('active')); $(`.step[data-step="${key}"]`).classList.add('active'); }
function stepDone(key){ const s=$(`.step[data-step="${key}"]`); s.classList.remove('active'); s.classList.add('done'); }
function barPct(){ $('#bar').style.width = Math.min(100, Math.round(ledger.length/12*100))+'%'; }
function fmtUSD(x){ if(x==null||isNaN(x)) return '‚Äî'; return 'USD '+Number(x).toLocaleString(); }
function generateQRCodeDataURL(text, size=300){
  try{
    const encoded = encodeURIComponent(text);
    const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encoded}`;
    return qrApiUrl;
  }catch(e){
    console.warn('generateQRCodeDataURL error:', e);
    return null;
  }
}

function showQROverlay(blockHash, blockIndex){
  try{
    const qrText = `sov://block/${blockHash}`;
    const qrApiUrl = generateQRCodeDataURL(qrText, 300);
    $('#qr-title').textContent = `Block #${blockIndex} Reference`;
    $('#qr-desc').textContent = `Scan with any QR scanner to access or reference this block`;
    $('#qr-hash').textContent = `Hash: ${blockHash}`;
    $('#qr-link').textContent = qrText;
    
    if(qrApiUrl){
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 300;
        canvas.height = 300;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, 300, 300);
        ctx.drawImage(img, 0, 0, 300, 300);
      };
      img.onerror = ()=>{
        const canvas = document.getElementById('qr-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 300;
        canvas.height = 300;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, 300, 300);
        ctx.fillStyle = '#000';
        ctx.font = '12px monospace';
        ctx.fillText('QR Code', 120, 140);
        ctx.fillText(qrText, 50, 160);
      };
      img.crossOrigin = 'anonymous';
      img.src = qrApiUrl;
    }
    $('#qr-overlay').style.display = 'flex';
  }catch(e){
    console.warn('showQROverlay error:', e);
    showErr(e);
  }
}

function closeQROverlay(){
  $('#qr-overlay').style.display = 'none';
}
document.addEventListener('click', (e)=>{
  const overlay = $('#qr-overlay');
  if(overlay && overlay.style.display === 'flex' && e.target === overlay){
    closeQROverlay();
  }
});
let ledger=[], prev="GENESIS", approvals=0, project=null, docs=0;
let insights={prem:null,reins:null,head:null,stage:'‚Äî'};
let pdfByIndex = {};
let completed = { CREATE:false,DOCS:false,INTERFACE:false,ENGINE:false,DD_OUT:false,ECA_PRICING:false,POLICY_OUT:false,CREDIT_COMMITTEE:false,FACILITY:false,TREASURY:false,PAYMENT_PACK:false,CONTRACTOR:false };
const actorMap = {
  CREATE: {owners:['SPONSOR'], notify:['AUDIT','PLATFORM']},
  DOCS: {owners:['AUDIT'], notify:['SPONSOR','ECA','PLATFORM']},
  INTERFACE: {owners:['ECA'], notify:['AUDIT','PLATFORM']},
  ENGINE: {owners:['PLATFORM'], notify:['AUDIT','ECA']},
  DD_OUT: {owners:['AUDIT'], notify:['ECA','BANK']},
  ECA_PRICING: {owners:['ECA'], notify:['AUDIT','BANK','PLATFORM']},
  POLICY_OUT: {owners:['ECA'], notify:['TREASURY','BANK','AUDIT']},
  CREDIT_COMMITTEE: {owners:['BANK'], notify:['ECA','TREASURY']},
  FACILITY: {owners:['BANK'], notify:['TREASURY','MINISTRY']},
  TREASURY: {owners:['TREASURY'], notify:['MINISTRY','BANK']},
  PAYMENT_PACK: {owners:['MINISTRY'], notify:['TREASURY','BANK','AUDIT']},
  CONTRACTOR: {owners:['CONTRACTOR'], notify:['MINISTRY','TREASURY','BANK']}
};
let currentActionActors = null; // set before calling openAction to show mapping
let profiles = [];
function loadProfiles(){ try{ const raw=localStorage.getItem('SOV_PROFILES'); profiles = raw? JSON.parse(raw): []; }catch(e){ profiles=[];} }
function saveProfiles(){ localStorage.setItem('SOV_PROFILES', JSON.stringify(profiles)); }
function newProfileId(){ return 'P-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8).toUpperCase(); }
let pdfUrls = [];
let fileUrls = [];
function revokeOldURLs(limit=200){
  try{
    while(pdfUrls.length>limit){ const u=pdfUrls.shift(); try{ URL.revokeObjectURL(u); }catch(e){} }
    while(fileUrls.length>limit){ const u=fileUrls.shift(); try{ URL.revokeObjectURL(u); }catch(e){} }
  }catch(e){ console.warn('revokeOldURLs',e); }
}
let notifications = [];
function saveNotifications(){ try{ localStorage.setItem('SOV_NOTIF', JSON.stringify(notifications)); }catch(e){} }
function loadNotifications(){ try{ const raw=localStorage.getItem('SOV_NOTIF'); notifications = raw? JSON.parse(raw): []; }catch(e){ notifications=[]; } }
let lastProfileByAction = {}; // action -> profileName
const actionToStep = {
  'CREATE_PROJECT':'CREATE','CONFIRM_DATA_ROOM':'DOCS','SAVE_INTERFACE':'INTERFACE','RUN_PIPELINE':'ENGINE','GENERATE_DD_OUTPUTS':'DD_OUT','RUN_PRICING_AND_REI_DEMO':'ECA_PRICING','POLICY_AND_SLIP':'POLICY_OUT','CREDIT_COMMITTEE':'CREDIT_COMMITTEE','ISSUE_FACILITY':'FACILITY','ISSUE_SOV_GUARANTEE':'TREASURY','GENERATE_PAYMENT_PACK':'PAYMENT_PACK','FULFILL_PROJECT':'CONTRACTOR'
};
const actionToButton = {
  'CREATE_PROJECT':'#btn1','CONFIRM_DATA_ROOM':'#btn2','SAVE_INTERFACE':'#btn3','RUN_PIPELINE':'#btn4','GENERATE_DD_OUTPUTS':'#btn5','RUN_PRICING_AND_REI_DEMO':'#btn6','POLICY_AND_SLIP':'#btn7','CREDIT_COMMITTEE':'#btn8','ISSUE_FACILITY':'#btn9','ISSUE_SOV_GUARANTEE':'#btn10','GENERATE_PAYMENT_PACK':'#btn11','FULFILL_PROJECT':'#btn12'
};

function pushNotification(role, msg){ const n={t:new Date().toLocaleString(), role, msg}; notifications.unshift(n); saveNotifications(); }
function clearNotifications(){ notifications = []; saveNotifications(); }
function showNotificationToast(role, msg, actor, action){
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #0e5c38;
    color: #eafff5;
    border: 1px solid #17a86f;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    max-width: 380px;
    z-index: 3000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease-out;
  `;
  toast.innerHTML = `
    <div style="font-weight:700;margin-bottom:4px">üì¨ Notification sent to ${role}</div>
    <div style="opacity:0.9;margin-bottom:4px">${msg}</div>
    <div style="opacity:0.7;font-size:12px">Action: ${action} | ${new Date().toLocaleTimeString()}</div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);
function simulateRecipientResponses(originalBlockHash, notificationsMetadata){
  if(!notificationsMetadata || notificationsMetadata.length === 0) return;
  
  notificationsMetadata.forEach((notif, idx) => {
    const delayMs = 2000 + (idx * 800); // 2-3+ second delay per notification
    setTimeout(() => {
      try {
        const approverNames = {
          'INVESTOR': 'Morgan Capital',
          'AUDITOR': 'Ernst Compliance',
          'LEGAL': 'Baker & Smith LLP',
          'TRUSTEE': 'Sovereign Trust Co',
          'REGULATOR': 'FCA Authority',
          'LENDER': 'Goldman Secured',
          'ADVISOR': 'McKinsey Partners',
          'INSURANCE': 'AIG Risk Mgmt',
          'CONTRACTOR': 'BuildRight Inc',
          'DATA_CURATOR': 'DataCore Systems'
        };
        
        const approver = approverNames[notif.role] || `${notif.role} Approver`;
        const approval = Math.random() > 0.15; // 85% approval rate
        const receivedTs = new Date().toLocaleString();
        const responsePayload = {
          notification_response: {
            original_action_hash: originalBlockHash,
            recipient_role: notif.role,
            recipient_approver: approver,
            message_received: notif.message,
            received_timestamp: receivedTs,
            approval_status: approval ? 'APPROVED' : 'REJECTED',
            response_details: approval 
              ? `${approver} reviewed and approved the ${notif.message.split(' performed ')[1] || 'action'}`
              : `${approver} requested further clarification before approval`,
            response_timestamp: new Date().toLocaleString()
          }
        };
        appendBlock(approver, 'NOTIFICATION_RESPONSE', responsePayload);
        const statusEmoji = approval ? '‚úÖ' : '‚ö†Ô∏è';
        const statusText = approval ? 'Approved' : 'Requested Review';
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: ${approval ? '#0e5c38' : '#5c2e0f'};
          color: ${approval ? '#eafff5' : '#ffe5d5'};
          border: 1px solid ${approval ? '#17a86f' : '#ad6f00'};
          border-radius: 8px;
          padding: 12px 16px;
          font-size: 13px;
          max-width: 360px;
          z-index: 3000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          animation: slideIn 0.3s ease-out;
        `;
        toast.innerHTML = `
          <div style="font-weight:700;margin-bottom:4px">${statusEmoji} ${approver} ‚Äî ${statusText}</div>
          <div style="opacity:0.9;font-size:12px">${responsePayload.notification_response.response_details}</div>
          <div style="opacity:0.7;font-size:11px;margin-top:4px">${receivedTs}</div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => toast.remove(), 300);
        }, 6000);
        
      } catch(e) { console.warn('simulateRecipientResponses error:', e); }
    }, delayMs);
  });
}
function updateProfileBadges(){ try{ Object.entries(actionToButton).forEach(([action,sel])=>{ const el=document.querySelector(sel); if(!el) return; // remove old badge
    let badge = el.querySelector('.profile-badge'); if(badge) badge.remove(); const pname = lastProfileByAction[action]; if(pname){ badge = document.createElement('span'); badge.className='profile-badge'; badge.style.marginLeft='8px'; badge.style.fontSize='12px'; badge.style.opacity='.9'; badge.textContent=`${pname}`; el.appendChild(badge);} }); }catch(e){console.warn(e);} }
function appendBlock(actor, action, payload){
  try{
    if(payload && payload.actor_profile){ try{ loadProfiles(); const p = profiles.find(x=>x.id===payload.actor_profile); if(p){ payload.actor_profile_summary = {id:p.id, name:p.name, company:p.company, role:p.role}; } }catch(e){} }
    const payloadStr = JSON.stringify(payload||{});
      const payloadHash = demoHash(payloadStr + actor + action);
    const content = JSON.stringify({i:ledger.length, actor, action, payloadHash, prev});
    const hash = demoHash(content+prev);
    const blk = {i:ledger.length, t:new Date().toLocaleString(), actor, action, payload, payloadHash, prev, hash};
    ledger.push(blk); prev=hash;
    try{ autoLogChangeEntry(actor, action, hash); }catch(e){ console.warn('auto-changelog',e); }
    approvals=Math.min(12, approvals+1); $('#p-approvals').textContent=approvals+' / 12';
    updateInsights();
    let notifications_metadata = [];
    try{
      const step = actionToStep[action] || null;
      const notify = step && actorMap[step] ? (actorMap[step].notify||[]) : [];
      const msg = `${actor} performed ${action}${payload&&payload.doc? ' on '+payload.doc : ''}`;
      notify.forEach(r=> { 
        const ts = new Date().toLocaleString();
        const n={t:ts, role:r, msg, action, status:'sent'}; 
        notifications.unshift(n);
        notifications_metadata.push({role:r, message:msg, timestamp:ts, status:'sent'});
        showNotificationToast(r, msg, actor, action);
      });
      if(blk.payload && notifications_metadata.length>0){
        blk.payload.notifications_metadata = notifications_metadata;
      }
      saveNotifications();
    }catch(e){ console.warn('notify',e); }
    try{ if(payload && payload.actor_profile_summary){ lastProfileByAction[action] = payload.actor_profile_summary.name; updateProfileBadges(); } }catch(e){}
  const tr=document.createElement('tr');
  const details = payloadStr.length>120? payloadStr.slice(0,120)+'‚Ä¶' : payloadStr;
  tr.innerHTML=`<td>${blk.i}</td><td>${blk.t}</td><td>${blk.actor}</td><td>${blk.action}</td><td style="opacity:.85">${details}</td><td><a class="hash" data-i="${blk.i}">${blk.hash.slice(0,12)}‚Ä¶</a> <a class="dash-link" data-i="${blk.i}" title="View scannable QR">[QR]</a></td>`;
    $('#tbl tbody').appendChild(tr);
    barPct();
    if(action !== 'NOTIFICATION_RESPONSE' && notifications_metadata.length > 0){
      simulateRecipientResponses(blk.hash, notifications_metadata);
    }
    return blk;
  }catch(e){ showErr(e); throw e; }
}
function exportCSV(){
  const head=['i','time','actor','action','payload','payloadHash','prev','hash'];
  const rows=[head.join(',')];
  ledger.forEach(b=>{
    const row=[b.i, JSON.stringify(b.t), b.actor, b.action, JSON.stringify(b.payload), b.payloadHash, b.prev, b.hash].join(',');
    rows.push(row);
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${(project&&project.id)||'PROJECT'}-ledger.csv`; a.click();
}
function openJSON(i){
  const b=ledger[i]; if(!b) return;
  const chain = [b]; // include small prev chain
  let p=b.prev, steps=0;
  while(steps<4 && p && p!=='GENESIS'){
    const j=ledger.findIndex(x=>x.hash===p); if(j<0) break;
    chain.unshift(ledger[j]); p=ledger[j].prev; steps++;
  }
  $('#json-pre').textContent=JSON.stringify({tip:b.hash, chain}, null, 2);
  $('#json').style.display='flex';
}
function closeJSON(){ $('#json').style.display='none'; }
function makePDF(name, title, lines, blockRef, autoDownload=false){
  try{
    const header = "SOVERNX ‚Ä¢ " + (project? project.name : "Project") + " ‚Ä¢ " + new Date().toLocaleString();
    let auditLines = [];
    let blkForMeta = null;
    try{
      const blk = getBlockByRef(blockRef);
      if(blk){ auditLines = buildAuditTrailLines(blk); blkForMeta = blk; }
    }catch(e){ console.warn('build audit lines', e); }

    const body = [header,'',title,'',...(lines||[]), '', '--- INFORMATION AUDIT TRAIL ---', '', ...auditLines].join('\n');
    const objs = fpdf(body, { blockHash: blkForMeta? blkForMeta.hash: null, title: title });
    let pdf = "%PDF-1.4\n";
    const offs = [0];
    for(const o of objs){ offs.push(pdf.length); pdf += o + "\n"; }
    const xrefStart = pdf.length;
    const objCount = objs.length;
    let xref = `xref\n0 ${objCount+1}\n0000000000 65535 f \n`;
    for(let i=0;i<objCount;i++){ const off = (i===0?0:offs[i]).toString().padStart(10,'0'); xref += `${off} 00000 ${i===0?'f':'n'} \n`; }
    const trailer = `trailer << /Size ${objCount+1} /Root 1 0 R >>\nstartxref\n${xrefStart}\n%%EOF`;
    const blob=new Blob([pdf + xref + trailer], {type: 'application/pdf'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.textContent='Download '+name; a.className='doclink';
    if(autoDownload){
      a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>{ try{ a.remove(); }catch(e){} }, 1500);
    } else {
      $('#docs').appendChild(a);
    }
    docs++; updateInsights();
    try{ pdfUrls.push(url); revokeOldURLs(200); }catch(e){}
    try{ if(blkForMeta){ pdfByIndex[blkForMeta.i] = url; } else if(ledger && ledger.length>0){ pdfByIndex[ledger[ledger.length-1].i] = url; } }catch(e){}
  }catch(e){ showErr(e); }
}
function fpdf(text, meta){
  const rawLines = String(text||'').split('\n');
  const lines = rawLines.map(l => l.replace(/[()]/g, '\\$&'));
  const linesPerPage = 44; // safe number for 11-12pt font
  const pageCount = Math.max(1, Math.ceil(lines.length / linesPerPage));
  const objs = [];

  const pageObjStart = 3;
  const contentObjStart = pageObjStart + pageCount;
  const fontObjId = contentObjStart + pageCount;
  const contentStreams = [];
  for(let p=0;p<pageCount;p++){
    const start = p*linesPerPage;
    const end = Math.min(lines.length, start + linesPerPage);
    let out = "q 0.82 0.68 0.22 rg 0 812 595 30 re f Q\n"; // gold header band
    out += "BT /F1 14 Tf 20 820 Td (SOVERNX) Tj ET\n";
    if(meta && meta.blockHash){
      out += `BT /F1 9 Tf 420 822 Td (Hash: ${String(meta.blockHash).slice(0,12)}‚Ä¶) Tj ET\n`;
    }
    let y = 780;
    for(let i=start;i<end;i++){
      out += `BT /F1 11 Tf 20 ${y} Td (${lines[i]}) Tj ET\n`;
      y -= 14;
    }
    const pageNum = p+1;
    out += `BT /F1 9 Tf 20 40 Td (Page ${pageNum} / ${pageCount}) Tj ET\n`;
    if(meta && meta.blockHash){
      out += `BT /F1 8 Tf 120 30 Td (QR: sov://block/${meta.blockHash}) Tj ET\n`;
    }
    contentStreams.push(out);
  }
  objs.push("1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj");
  const kids = [];
  for(let p=0;p<pageCount;p++) kids.push(`${pageObjStart + p} 0 R`);
  objs.push(`2 0 obj << /Type /Pages /Kids [${kids.join(' ')}] /Count ${pageCount} >> endobj`);
  for(let p=0;p<pageCount;p++){
    const pageId = pageObjStart + p;
    const contentId = contentObjStart + p;
    objs.push(`${pageId} 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Contents ${contentId} 0 R /Resources << /Font << /F1 ${fontObjId} 0 R >> >> >> endobj`);
  }
  for(let p=0;p<pageCount;p++){
    const cs = contentStreams[p];
    objs.push(`${contentObjStart + p} 0 obj << /Length ${cs.length} >> stream\n${cs}\nendstream endobj`);
  }
  objs.push(`${fontObjId} 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj`);

  return objs;
}
function buildAuditTrailLines(blk){
  try{
    if(!blk) return ['(no block)'];
    const lines = [];
    lines.push(`1. Originator: ${blk.actor} (block #${blk.i})`);
    lines.push(`2. Activity: ${blk.action}`);
    try{
      if(blk.payload){
        const pretty = JSON.stringify(blk.payload, null, 2).slice(0, 5000);
        lines.push('3. Information received:');
        pretty.split('\n').forEach(l=> lines.push('   ' + l));
        if(JSON.stringify(blk.payload, null, 2).length > 5000) lines.push('   (truncated)');
      } else {
        lines.push('3. Information received: ‚Äî');
      }
    }catch(e){ lines.push('3. Information received: (unserializable payload)'); }
    lines.push(`   ‚Ä¢ Input timestamp: ${blk.t}`);
    const proc = (blk.payload && blk.payload.process) || `Executed action '${blk.action}'`;
    lines.push(`4. Process executed: ${proc}`);
    const outputs = [];
    if(blk.payload){
      if(blk.payload.doc) outputs.push(`Document: ${blk.payload.doc}`);
      if(blk.payload.documents) outputs.push(`Documents: ${JSON.stringify(blk.payload.documents)}`);
      if(blk.payload.result) outputs.push(`Result: ${blk.payload.result}`);
      if(blk.payload.approval) outputs.push(`Approval: ${blk.payload.approval}`);
      if(blk.payload.notification_response) {
        outputs.push('Response:');
        try{
          const pr = JSON.stringify(blk.payload.notification_response, null, 2).split('\n').map(l=>('    '+l)).join(' | ');
          outputs.push(pr);
        }catch(e){ outputs.push(JSON.stringify(blk.payload.notification_response)); }
      }
    }
    if(outputs.length===0) outputs.push('‚Äî');
    lines.push(`5. Outputs: ${outputs.join(' | ')}`);
    const notifMeta = (blk.payload && blk.payload.notifications_metadata) || [];
    if(notifMeta.length>0){
      lines.push('6. Recipient list:');
      notifMeta.forEach(n=>{
        lines.push(`   ‚Ä¢ ${n.role}`);
      });
      lines.push('7. Information Sent and timestamp:');
      notifMeta.forEach(n=>{
        lines.push(`   ‚Ä¢ To ${n.role}: "${n.message}" at ${n.timestamp}`);
      });
    } else {
      lines.push('6. Recipient list: ‚Äî');
      lines.push('7. Information Sent and timestamp: ‚Äî');
    }
    const responses = [];
    try{
      ledger.forEach(b=>{
        if(b.action === 'NOTIFICATION_RESPONSE' && b.payload && b.payload.notification_response){
          const r = b.payload.notification_response;
          if(r.original_action_hash === blk.hash){
            responses.push({role: r.recipient_role, approver: r.recipient_approver, status: r.approval_status, received: r.received_timestamp || b.t, response_ts: r.response_timestamp || b.t, details: r.response_details});
          }
        }
      });
    }catch(e){ console.warn('audit responses', e); }
    if(responses.length>0){
      lines.push('8. Receiving timestamps:');
      responses.forEach(r=> lines.push(`   ‚Ä¢ ${r.role} received at ${r.received}`));
      lines.push('9. Approval actions and timestamps:');
      responses.forEach(r=> lines.push(`   ‚Ä¢ ${r.role} ‚Äî ${r.status} by ${r.approver} at ${r.response_ts} ‚Äî ${r.details}`));
    } else {
      lines.push('8. Receiving timestamps: ‚Äî');
      lines.push('9. Approval actions and timestamps: ‚Äî');
    }
    const allResponded = notifMeta.length>0 && responses.length >= notifMeta.length;
    lines.push(`10. Process status: ${allResponded? 'CLOSED' : 'IN PROGRESS'}`);
    return lines;
  }catch(e){ console.warn('buildAuditTrailLines', e); return ['(error building audit)']; }
}
function getBlockByRef(ref){
  try{
    if(!ref){ // null/undefined -> most recent
      return (Array.isArray(ledger) && ledger.length>0) ? ledger[ledger.length-1] : null;
    }
    if(typeof ref === 'object' && ref !== null && ref.i !== undefined) return ref;
    if(typeof ref === 'number') return ledger.find(b=>b.i===ref) || ledger[ref] || null;
    if(typeof ref === 'string'){
      let b = ledger.find(x=>x.hash === ref || String(x.i) === ref);
      if(b) return b;
      b = ledger.find(x=>x.hash && x.hash.startsWith(ref));
      if(b) return b;
    }
    return null;
  }catch(e){ console.warn('getBlockByRef', e); return null; }
}
let actResolve=null;
function openAction(title, fields){
  $('#act-title').textContent=title; $('#act-body').innerHTML='';
  if(currentActionActors){
    const mapDiv=document.createElement('div'); mapDiv.className='fld';
    const owners=(currentActionActors.owners||[]).join(', ')||'‚Äî';
    const notify=(currentActionActors.notify||[]).join(', ')||'‚Äî';
    mapDiv.innerHTML=`<label style="font-weight:700">Actors (owners):</label><div style="margin-bottom:6px">${owners}</div><label style="font-weight:700">Will be notified:</label><div style="opacity:.9">${notify}</div><hr style="border-color:#1b2450;margin-top:8px">`;
    $('#act-body').appendChild(mapDiv);
    try{
      const roleCandidates = currentActionActors.owners||[];
      const prow=document.createElement('div'); prow.className='fld';
      const plabel=document.createElement('label'); plabel.textContent='Actor Profile (select)';
      const psel=document.createElement('select'); psel.id='actor_profile'; psel.style.marginRight='8px';
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='-- select profile --'; psel.appendChild(opt0);
      try{ loadProfiles(); }catch(e){ console.warn('loadProfiles error', e); }
      let matches = [];
      if(roleCandidates && roleCandidates.length > 0){
        matches = profiles.filter(p=> roleCandidates.includes(p.role));
      } else {
        matches = profiles; // show all if no role filter
      }
      if(matches.length === 0 && profiles.length > 0){
        matches = profiles;
      }
      matches.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} ‚Äî ${p.company || '(no company)'} (${p.title || 'no title'})`; psel.appendChild(o); });
      const newBtn=document.createElement('button'); newBtn.className='btn'; newBtn.style.marginLeft='8px'; newBtn.textContent='New Profile'; newBtn.onclick=()=>{ openProfileModal(); };
      prow.appendChild(plabel); prow.appendChild(psel); prow.appendChild(newBtn);
      $('#act-body').appendChild(prow);
    }catch(e){ console.warn('profile select error',e); }
  }
  fields.forEach(f=>{
    const row=document.createElement('div'); row.className='fld';
    const id=f.name; const label=document.createElement('label'); label.textContent=f.label||f.name;
    let inp=document.createElement('input'); inp.type=f.type||'text'; inp.id=id;
    if(f.type==='checkbox'){ inp.checked=!!f.value; } else if(f.type==='file'){ inp.type='file'; if(f.multiple) inp.multiple=true; inp.accept=f.accept||''; } else { inp.value=(f.value??''); }
    if(f.required) inp.dataset.req='1';
    row.appendChild(label); row.appendChild(inp);
    $('#act-body').appendChild(row);
  });
  function validate(){
    let ok=true; $$('#act-body input, #act-body select').forEach(i=>{ if(i.dataset.req && ((i.type==='checkbox' && !i.checked) || (i.type==='file' && !i.files?.length) || (i.tagName==='SELECT' && !i.value) || (!i.value && i.type!=='checkbox' && i.type!=='file' && i.tagName!=='SELECT'))) ok=false; });
    $('#act-submit').disabled=!ok;
  }
  $$('#act-body input, #act-body select').forEach(i=> i.addEventListener('input', validate));
  validate();
  $('#act-bar').style.width='0%';
  $('#action').style.display='flex';
  $('#act-submit').onclick=null;
  $('#act-submit').onclick=()=>finishAction();
  $('#act-force').onclick=()=>finishAction(true);
  setTimeout(()=>{ const first=$$('#act-body input')[0]; if(first) first.focus(); }, 50);
  return new Promise(res=>{ actResolve=res; });
}
function finishAction(force=false){
  let t=0; const dur=force?80:700;
  const timer=setInterval(()=>{
    t+=100; $('#act-bar').style.width=Math.min(100, t/dur*100)+'%';
    if(t>=dur){ clearInterval(timer);
      const vals={}; $$('#act-body input, #act-body select').forEach(i=>{ 
        if(i.type==='checkbox') { vals[i.id]= i.checked; }
        else if(i.type==='file') { 
          vals[i.id]= i.files?.length ? Array.from(i.files).map(f=>({name:f.name, size:f.size, type:f.type})) : [];
          vals.__files__ = vals.__files__ || {};
          vals.__files__[i.id] = i.files?.length ? Array.from(i.files) : [];
        }
        else { vals[i.id]= i.value; } 
      });
      $('#action').style.display='none'; if(actResolve) actResolve(vals);
      currentActionActors = null;
    }
  },100);
}
function closeAction(){ $('#action').style.display='none'; if(actResolve) actResolve(null); }

let subResolve=null;
function openSub(title, body, duration=800){
  $('#sub-title').textContent=title; $('#sub-body').innerHTML=body; $('#sub-bar').style.width='0%'; $('#sub-accept').disabled=true;
  $('#sub').style.display='flex';
  if(openSub.initCallback){ try{ openSub.initCallback(duration); }catch(e){ console.warn('openSub initCallback error:', e); } openSub.initCallback=null; }
  let t=0; const timer=setInterval(()=>{ t+=100; $('#sub-bar').style.width=Math.min(100,t/duration*100)+'%'; if(t>=duration){ clearInterval(timer); $('#sub-accept').disabled=false; } },100);
  return new Promise(res=>{ subResolve=res; });
}
function closeSub(ok){ $('#sub').style.display='none'; if(subResolve) subResolve(!!ok); }
$('#sub-accept').addEventListener('click',()=>closeSub(true));
function applyRole(){
  const r=$('#role').value;
  const projectStarted = !!project; // Check if project has been created
  
  $$('.buttons .btn-step').forEach(b=>{
    const br=b.getAttribute('data-role');
    const isVisible = (r==='ALL' || r===br);
    b.style.display = isVisible ? 'inline-flex' : 'none';
  });
  
  $$('.timeline .step').forEach(s=>{
    const sr=s.getAttribute('data-role');
    const isVisible = (r==='ALL' || r===sr);
    s.style.display = isVisible ? 'block' : 'none';
  });
  
  // Disable buttons for steps that come after project creation if project hasn't started
  if(!projectStarted){
    // Only btn1 (CREATE_PROJECT) should be enabled if no project exists
    $$('.buttons .btn-step').forEach(b=>{
      const btnId = b.id;
      if(btnId !== 'btn1'){
        b.disabled = true;
        b.title = 'Project must be created first';
      }
    });
  }
}

// Sync IAM login to role dropdown: when user signs in, auto-select their primary role
function syncIAMToRoleDropdown(currentClaims){
  const c = currentClaims || (window.sxClaims && window.sxClaims()) || null;
  if(c && c.roles && c.roles.length > 0){
    const primaryRole = String(c.roles[0] || '').toUpperCase(); // Use first/primary role
    const roleSelect = $('#role');
    if(roleSelect){
      // Check if the role exists in the dropdown
      const option = Array.from(roleSelect.options).find(opt => opt.value.toUpperCase() === primaryRole);
      if(option){
        roleSelect.value = option.value;
      } else {
        // If signed-in role isn't in dropdown, keep current selection or default to ALL
        if(roleSelect.value !== 'ALL'){
          roleSelect.value = 'ALL';
        }
      }
      applyRole(); // Apply filtering based on signed-in role
    }
  }
}

document.getElementById('role').addEventListener('change', applyRole);
function saveState(){
  const state={project, ledger, approvals, prev, docs, insights, completed};
  localStorage.setItem('SOVERNX_DEMO', JSON.stringify(state));
  $('#saveState').textContent='Yes ('+new Date().toLocaleTimeString()+')';
}
function loadState(){
  const raw=localStorage.getItem('SOVERNX_DEMO'); if(!raw) return;
  try{
    const s=JSON.parse(raw); project=s.project; ledger=s.ledger||[]; approvals=s.approvals||0; prev=s.prev||'GENESIS'; docs=s.docs||0; insights=s.insights||insights; completed=s.completed||completed;
    $('#tbl tbody').innerHTML='';
    ledger.forEach(b=>{
      const ps=JSON.stringify(b.payload||{}); const details = ps.length>120?ps.slice(0,120)+'‚Ä¶':ps;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${b.i}</td><td>${b.t}</td><td>${b.actor}</td><td>${b.action}</td><td style="opacity:.85">${details}</td><td><a class="hash" data-i="${b.i}">${b.hash.slice(0,12)}‚Ä¶</a></td>`;
      $('#tbl tbody').appendChild(tr);
    });
    $('#p-approvals').textContent=approvals+' / 12'; barPct();
    if(project){ $('#p-title').textContent=project.name; $('#p-meta').textContent=`Value ${Number(project.valueUSD).toLocaleString()} | Tenor ${project.tenor}m | Risk ${project.risk} | Country ${project.country}`;}
    updateInsights();
    $('#saveState').textContent='Loaded';
    Object.entries(completed).forEach(([k,v])=>{ if(v){ $(`.step[data-step="${k}"]`).classList.add('done'); } });
  }catch(e){ showErr(e); }
}
$('#btnSave').addEventListener('click', saveState);
$('#btnLoad').addEventListener('click', loadState);
$('#btnCSV').addEventListener('click', exportCSV);
function updateInsights(){
  $('#ins_stage').textContent=insights.stage;
  $('#ins_appr').textContent=approvals;
  $('#ins_prem').textContent=insights.prem? (Number(insights.prem).toFixed(2)+'%') : '‚Äî';
  $('#ins_reins').textContent=insights.reins? fmtUSD(insights.reins) : '‚Äî';
  $('#ins_head').textContent=insights.head? (Number(insights.head).toFixed(1)+'m') : '‚Äî';
  $('#ins_docs').textContent=docs;
}
function enable(id){ $(id).disabled=false; }
function progressBtn(id){ setBtn($(id),'state-progress'); }
function doneBtn(id){ setBtn($(id),'state-done'); }
document.addEventListener('click', (e)=>{
  const a=e.target.closest('a.hash'); if(!a) return;
  openJSON(Number(a.dataset.i));
});
document.addEventListener('click', (e)=>{
  const a=e.target.closest('a.dash-link'); if(!a) return;
  e.preventDefault();
  const idx = Number(a.dataset.i);
  const blk = ledger.find(b=>b.i===idx);
  if(!blk){ return; }
  showQROverlay(blk.hash, blk.i);
});
function openDash(){
  const body = [];
  // Workflow map: [key, ownerRole, label]
  const map = [
    ['CREATE','SPONSOR','1. Create Project'],
    ['DOCS','AUDIT','2. Data Room'],
    ['INTERFACE','ECA','3. Interface'],
    ['ENGINE','PLATFORM','4. Project Due Dilligence'],
    ['DD_OUT','AUDIT','5. DD Outputs'],
    ['ECA_PRICING','ECA','6. ECA/ECIC'],
    ['POLICY_OUT','ECA','7. Policy & Slip'],
    ['CREDIT_COMMITTEE','BANK','8. Bank/DFI'],
    ['FACILITY','BANK','9. Facility'],
    ['TREASURY','TREASURY','10. Treasury'],
    ['PAYMENT_PACK','MINISTRY','11. Ministry: Payment Pack'],
  ];

  // Determine active role from UI (dropdown)
  const roleSelect = document.getElementById('role');
  const activeRole = roleSelect ? roleSelect.value : 'ALL';

  // Filter steps by active role (ALL = full view)
  const filtered = (activeRole && activeRole !== 'ALL')
      ? map.filter(([k,owner]) => owner === activeRole)
      : map.slice();

  // Helper: derive step status
  function stepStatus(key){
    if (completed && completed[key]) return 'Completed';
    const base = key.split('_')[0];
    const hit = (ledger || []).find(b => b.action && (b.action.includes(base) || b.action.includes(key)));
    return hit ? 'In Progress' : 'Not Started';
  }

  // Compute simple metrics for dashboard header
  let totalSteps = filtered.length;
  let done = 0, inProg = 0, notStarted = 0;
  filtered.forEach(([k])=>{
    const st = stepStatus(k);
    if (st === 'Completed') done++;
    else if (st === 'In Progress') inProg++;
    else notStarted++;
  });

  // Actor label
  const actorLabel = (activeRole === 'ALL') ? 'All Actors' : activeRole + ' Actor View';

  // Header & summary cards row
  body.push(`<div style="margin-bottom:10px;">
    <div style="font-weight:600;margin-bottom:4px;">Actor Dashboard ¬∑ ${actorLabel}</div>
    <div style="font-size:12px;opacity:.8">
      This view shows only the workflow steps owned by the selected actor role.
    </div>
  </div>`);

  body.push('<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">');
  body.push(`<div class="card" style="flex:1 1 140px;min-width:140px;">
    <div style="font-size:11px;opacity:.8;">Total Steps</div>
    <div style="font-size:20px;font-weight:700;">${totalSteps}</div>
  </div>`);
  body.push(`<div class="card" style="flex:1 1 140px;min-width:140px;">
    <div style="font-size:11px;opacity:.8;">Completed</div>
    <div style="font-size:20px;font-weight:700;color:#22c55e;">${done}</div>
  </div>`);
  body.push(`<div class="card" style="flex:1 1 140px;min-width:140px;">
    <div style="font-size:11px;opacity:.8;">In Progress</div>
    <div style="font-size:20px;font-weight:700;color:#fbbf24;">${inProg}</div>
  </div>`);
  body.push(`<div class="card" style="flex:1 1 140px;min-width:140px;">
    <div style="font-size:11px;opacity:.8;">Not Started</div>
    <div style="font-size:20px;font-weight:700;color:#9ca3af;">${notStarted}</div>
  </div>`);
  body.push('</div>');

  // Detailed table per step
  body.push('<table style="width:100%;border-collapse:collapse;margin-top:4px;">');
  body.push('<tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #1b2450">Step</th><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #1b2450">Owner</th><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #1b2450">Status</th><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #1b2450">Last Action</th></tr>');

  filtered.forEach(([k,owner,label])=>{
    const st = stepStatus(k);
    const statusBadge =
      st === 'Completed'
        ? '<span class="badge b-green">Completed</span>'
        : st === 'In Progress'
          ? '<span class="badge b-amber">In Progress</span>'
          : '<span class="badge b-grey">Not Started</span>';

    const base = k.split('_')[0];
    const last = [...(ledger || [])].reverse().find(b => b.action && (b.action.includes(base) || b.action.includes(k)))
      || (ledger && ledger.length ? ledger[ledger.length-1] : null);
    const lastHtml = last
      ? `<a href="#" class="dash-link" data-i="${last.i}">${last.actor}: ${last.action}</a>`
      : '‚Äî';

    body.push(
      `<tr>
        <td style="padding:6px 8px;border-bottom:1px solid #1b2450;">${label}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #1b2450;">${owner}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #1b2450;">${statusBadge}</td>
        <td style="padding:6px 8px;border-bottom:1px solid #1b2450;">${lastHtml}</td>
      </tr>`
    );
  });
  body.push('</table>');

  // Project + financial insights footer (re-using existing globals if available)
  body.push(`<div style="margin-top:10px;opacity:.85">
    Project: <b>${project ? (project.name || '‚Äî') : '‚Äî'}</b>
    ‚Ä¢ Actor: <b>${activeRole || 'ALL'}</b>
    ‚Ä¢ Approvals ${typeof approvals !== 'undefined' ? approvals : '0'} / 12
    ‚Ä¢ Premium: ${insights && insights.prem ? insights.prem : '‚Äî'}
    ‚Ä¢ Reinsurance: ${insights && insights.reins ? insights.reins : '‚Äî'}
    ‚Ä¢ Headroom ${insights && insights.head ? Number(insights.head).toFixed(1) + 'm' : '‚Äî'}
  </div>`);

  $('#dash-body').innerHTML = body.join('');
  $('#dash').style.display = 'flex';
}
function closeDash(){ $('#dash').style.display='none'; }
$('#btnDash').addEventListener('click', openDash);
const notifAuditBtn = document.getElementById('btnNotifAudit'); if(notifAuditBtn) notifAuditBtn.addEventListener('click', openNotifAudit);
function renderNotificationAudit(){
  try {
    const auditLines = [];
    const notificationMap = {}; // key: originalActionHash, value: {sent, responses[]}
    ledger.forEach(blk => {
      if(blk.payload && blk.payload.notifications_metadata) {
        if(!notificationMap[blk.hash]) {
          notificationMap[blk.hash] = {
            sent_block_index: blk.i,
            sent_timestamp: blk.t,
            sent_actor: blk.actor,
            sent_action: blk.action,
            notifications: blk.payload.notifications_metadata,
            responses: []
          };
        }
      }
    });
    ledger.forEach(blk => {
      if(blk.action === 'NOTIFICATION_RESPONSE' && blk.payload && blk.payload.notification_response) {
        const resp = blk.payload.notification_response;
        const origHash = resp.original_action_hash;
        if(notificationMap[origHash]) {
          notificationMap[origHash].responses.push({
            block_index: blk.i,
            response_timestamp: blk.t,
            recipient_role: resp.recipient_role,
            approver: resp.recipient_approver,
            approval_status: resp.approval_status,
            response_details: resp.response_details
          });
        }
      }
    });
    auditLines.push('<div style="margin-bottom:20px">');
    auditLines.push('<h3 style="margin:0 0 12px;color:var(--gold);font-size:15px">üìä Notification Timeline</h3>');
    
    if(Object.keys(notificationMap).length === 0) {
      auditLines.push('<div style="opacity:0.7;padding:12px;background:#0d1640;border-radius:8px">No notifications sent yet.</div>');
    } else {
      Object.entries(notificationMap).forEach(([hash, entry]) => {
        auditLines.push(`<div style="background:#0d1640;border:1px solid #1b2450;border-radius:8px;padding:12px;margin-bottom:12px">`);
        auditLines.push(`<div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #263471">`);
        auditLines.push(`<div style="font-weight:700;color:var(--blue)">üì§ Action Initiated</div>`);
        auditLines.push(`<div style="font-size:12px;margin-top:4px;opacity:0.9">`);
        auditLines.push(`<span style="color:var(--amber)">${entry.sent_actor}</span> performed <span style="color:var(--ink)">${entry.sent_action}</span> at ${entry.sent_timestamp}`);
        auditLines.push(`</div>`);
        auditLines.push(`<div style="margin-top:8px;padding-left:12px;border-left:2px solid #1b2450">`);
        entry.notifications.forEach(n => {
          auditLines.push(`<div style="font-size:12px;margin:4px 0;opacity:0.85">`);
          auditLines.push(`üì¨ Sent to <b>${n.role}</b>: "${n.message}" at ${n.timestamp}`);
          auditLines.push(`</div>`);
        });
        auditLines.push(`</div>`);
        auditLines.push(`</div>`);
        if(entry.responses.length > 0) {
          auditLines.push(`<div style="margin-top:8px;padding-top:8px">`);
          entry.responses.forEach(resp => {
            const statusIcon = resp.approval_status === 'APPROVED' ? '‚úÖ' : '‚ö†Ô∏è';
            const statusColor = resp.approval_status === 'APPROVED' ? 'var(--green)' : 'var(--amber)';
            auditLines.push(`<div style="background:#0a1333;border-left:3px solid ${statusColor};padding:8px;margin-bottom:8px;border-radius:4px">`);
            auditLines.push(`<div style="font-weight:700;color:${statusColor};margin-bottom:4px">`);
            auditLines.push(`${statusIcon} Response from ${resp.approver} (${resp.recipient_role})`);
            auditLines.push(`</div>`);
            auditLines.push(`<div style="font-size:12px;opacity:0.85;margin-bottom:4px">`);
            auditLines.push(`Status: <b>${resp.approval_status}</b>`);
            auditLines.push(`</div>`);
            auditLines.push(`<div style="font-size:12px;opacity:0.8;margin-bottom:4px">`);
            auditLines.push(`${resp.response_details}`);
            auditLines.push(`</div>`);
            auditLines.push(`<div style="font-size:11px;opacity:0.6">`);
            auditLines.push(`Received: ${resp.response_timestamp}`);
            auditLines.push(`</div>`);
            auditLines.push(`</div>`);
          });
          auditLines.push(`</div>`);
        } else {
          auditLines.push(`<div style="margin-top:8px;padding:8px;background:#0a1333;border-radius:4px;font-size:12px;opacity:0.7">`);
          auditLines.push(`‚è≥ Awaiting responses...`);
          auditLines.push(`</div>`);
        }
        
        auditLines.push(`</div>`);
      });
    }
    
    auditLines.push('</div>');
    $('#notif-audit-body').innerHTML = auditLines.join('');
  } catch(e) {
    console.warn('renderNotificationAudit error:', e);
    $('#notif-audit-body').innerHTML = `<div style="color:var(--amber)">Error rendering audit: ${e.message}</div>`;
  }
}

function openNotifAudit(){
  renderNotificationAudit();
  $('#notif-audit').style.display='flex';
}

function closeNotifAudit(){
  $('#notif-audit').style.display='none';
}

function exportNotificationAudit(){
  try {
    const auditData = {
      timestamp: new Date().toLocaleString(),
      project: project ? project.name : 'Unknown',
      notifications_audit: []
    };
    const notificationMap = {};
    ledger.forEach(blk => {
      if(blk.payload && blk.payload.notifications_metadata) {
        if(!notificationMap[blk.hash]) {
          notificationMap[blk.hash] = {
            sent_block_index: blk.i,
            sent_timestamp: blk.t,
            sent_actor: blk.actor,
            sent_action: blk.action,
            notifications: blk.payload.notifications_metadata,
            responses: []
          };
        }
      }
    });
    
    ledger.forEach(blk => {
      if(blk.action === 'NOTIFICATION_RESPONSE' && blk.payload && blk.payload.notification_response) {
        const resp = blk.payload.notification_response;
        const origHash = resp.original_action_hash;
        if(notificationMap[origHash]) {
          notificationMap[origHash].responses.push({
            block_index: blk.i,
            response_timestamp: blk.t,
            recipient_role: resp.recipient_role,
            approver: resp.recipient_approver,
            approval_status: resp.approval_status,
            response_details: resp.response_details
          });
        }
      }
    });
    
    auditData.notifications_audit = Object.values(notificationMap);
    
    const blob = new Blob([JSON.stringify(auditData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${(project && project.id) || 'PROJECT'}-notification-audit.json`;
    a.click();
  } catch(e) {
    console.warn('exportNotificationAudit error:', e);
    showErr(e);
  }
}
function makeStakeholderReport(){
  const lines=[];
  lines.push(`Project: ${project?project.name:'‚Äî'}`);
  lines.push(`Approvals: ${approvals}/12  | Docs: ${docs}`);
  lines.push(`Premium est: ${insights.prem?Number(insights.prem).toFixed(2)+'%':'‚Äî'} | Reins: ${insights.reins?Number(insights.reins).toLocaleString():'‚Äî'} | Headroom: ${insights.head?Number(insights.head).toFixed(1)+'m':'‚Äî'}`);
  lines.push('');
  const map=[
    ['CREATE','SPONSOR','1. Create Project'],
    ['DOCS','AUDIT','2. Data Room'],
    ['INTERFACE','ECA','3. Interface'],
    ['ENGINE','PLATFORM','4. Project Due Dilligence'],
    ['DD_OUT','AUDIT','5. DD Outputs'],
    ['ECA_PRICING','ECA','6. ECA/ECIC'],
    ['POLICY_OUT','ECA','7. Policy & Slip'],
    ['CREDIT_COMMITTEE','BANK','8. Bank/DFI'],
    ['FACILITY','BANK','9. Facility'],
    ['TREASURY','TREASURY','10. Treasury'],
    ['PAYMENT_PACK','MINISTRY','11. Ministry: Payment Pack'],
  ];
  map.forEach(([k,owner,label])=>{
    const st = completed[k] ? 'Complete' : (insights.stage.includes(label.split('. ')[1]) ? 'In Progress' : 'Not Started');
    lines.push(`${label} ‚Äî ${owner}: ${st}`);
  });
  const snapshotBlock = [...ledger].reverse().find(b=>b.action === 'VERSION_SNAPSHOT') || null;
  if(snapshotBlock){
    makePDF(`${(project&&project.id)||'PROJECT'}-Stakeholder_Report.pdf`, 'Stakeholder Collated Report', lines, snapshotBlock.hash);
  } else {
    makePDF(`${(project&&project.id)||'PROJECT'}-Stakeholder_Report.pdf`, 'Stakeholder Collated Report', lines);
  }
}
document.getElementById('btnStakeReport').addEventListener('click', makeStakeholderReport);
function openFileDB(){
  return new Promise((res,rej)=>{
    const rq = indexedDB.open('sovfiles',1);
    rq.onupgradeneeded = e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'id',autoIncrement:true}); };
    rq.onsuccess = e=>res(e.target.result);
    rq.onerror = e=>rej(e.target.error||e);
  });
}
async function saveFilesToDB(files){
  if(!files || !files.length) return [];
  const db = await openFileDB();
  const tx = db.transaction('files','readwrite'); const store = tx.objectStore('files');
  const saved = [];
  for(const f of files){
    const req = store.add({name:f.name,type:f.type,size:f.size,blob:f});
    const id = await new Promise((res,rej)=>{ req.onsuccess=e=>res(req.result); req.onerror=e=>rej(e); });
    const url = URL.createObjectURL(f);
    saved.push({id,name:f.name,type:f.type,size:f.size,url});
    try{ fileUrls.push(url); revokeOldURLs(200); }catch(e){}
  }
  await new Promise((res,rej)=>{ tx.oncomplete=res; tx.onerror=rej; });
  return saved;
}
async function getFileURLById(id){ const db=await openFileDB(); const tx=db.transaction('files','readonly'), store=tx.objectStore('files'); const req = store.get(id); return await new Promise((res,rej)=>{ req.onsuccess=e=>{ const r=req.result; if(!r) return res(null); const url=URL.createObjectURL(r.blob); res(url);} ; req.onerror=e=>rej(e); }); }
function displayRiskModelingProcessing(){
  const html = `
    <div class="proc-windows">
      <div class="proc-window">
        <h3>Core Actuarial and Risk Models</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-1" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-1-text">0%</div>
        </div>
        <div class="proc-stat">Analyzing 12,500+ data points</div>
        <div class="proc-items">Parametric models ‚Ä¢ Loss curves ‚Ä¢ Severity analysis</div>
      </div>
      <div class="proc-window">
        <h3>Quantitative Risk Models</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-2" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-2-text">0%</div>
        </div>
        <div class="proc-stat">Processing Monte Carlo simulation</div>
        <div class="proc-items">Tail risk ‚Ä¢ VAR/CVaR ‚Ä¢ Copula models</div>
      </div>
      <div class="proc-window">
        <h3>Machine Learning and Predictive Analysis</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-3" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-3-text">0%</div>
        </div>
        <div class="proc-stat">Training neural networks</div>
        <div class="proc-items">XGBoost ‚Ä¢ LSTM ‚Ä¢ Feature extraction</div>
      </div>
      <div class="proc-window">
        <h3>Underwriting and Project Tools</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-4" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-4-text">0%</div>
        </div>
        <div class="proc-stat">Validating 8 risk criteria</div>
        <div class="proc-items">Covenant checks ‚Ä¢ Project scoring ‚Ä¢ Final approval</div>
      </div>
    </div>
  `;
  return html;
}
function displayPricingProcessing(){
  const html = `
    <div class="proc-windows" style="grid-template-columns:1fr 1fr">
      <div class="proc-window">
        <h3>Traditional Actuarial Models</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-5" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-5-text">0%</div>
        </div>
        <div class="proc-stat">Computing premium rates</div>
        <div class="proc-items">GLMs ‚Ä¢ Deterministic models ‚Ä¢ Stochastic ‚Ä¢ Risk models ‚Ä¢ Experience rating ‚Ä¢ Scenario analyses</div>
      </div>
      <div class="proc-window">
        <h3>Machine Learning Models</h3>
        <div class="proc-spinner-container">
          <svg class="proc-spinner-svg" viewBox="0 0 70 70">
            <circle class="proc-spinner-bg" cx="35" cy="35" r="30" />
            <circle class="proc-spinner-progress" id="spinner-6" cx="35" cy="35" r="30" />
          </svg>
          <div class="proc-spinner-text" id="spinner-6-text">0%</div>
        </div>
        <div class="proc-stat">Optimizing model ensemble</div>
        <div class="proc-items">GBM ‚Ä¢ ANN ‚Ä¢ CNN ‚Ä¢ Random Forest ‚Ä¢ SVM</div>
      </div>
    </div>
  `;
  return html;
}
function sovereignCheckAuto(docName, actor='AUDIT', pass=true, note='Auto test'){ const payload={doc:docName, actor, result: pass? 'PASS':'FAIL', checks:{veracity:pass, compliance:pass, accountability:pass? 'AutoTest Team':'', authorisation:pass? 'AutoTest':'', finalApproval:pass, notes:note}}; const blk = appendBlock(actor,'SOV_TRUST_CHECK',payload); try{ makePDF(`${(project&&project.id)||'PROJECT'}-SOV_TRUST_${docName.replace(/\s+/g,'_')}.pdf`, `SOVEREIGN TRUST CHECK ‚Ä¢ ${docName}`, [`Document: ${docName}`, `Result: ${payload.result}`, `Notes: ${note}`], blk.hash); }catch(e){} return {...payload, passed:pass}; }
const btnActors = document.createElement('button'); btnActors.className='btn'; btnActors.id='btnActors'; btnActors.textContent='Configure Actors';
document.querySelector('.row .row').appendChild(btnActors);
const actorsModalHtml = `
<div id="actors" class="action" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center"><b>Actor Mapping Configuration</b><button class="btn" onclick="document.getElementById('actors').style.display='none'">Close</button></div><hr style="border-color:#1b2450">
  <div style="opacity:.9;margin-bottom:8px">Edit JSON mapping of step keys to owners/notify lists. Example: {"CREATE": {"owners":["SPONSOR"], "notify":["AUDIT"]}}</div>
  <textarea id="actors-json" style="width:100%;height:260px;background:#06102a;border:1px solid #263471;color:#cfe7ff;padding:8px;border-radius:8px"></textarea>
  <div style="margin-top:8px;display:flex;justify-content:flex-end"><button class="btn" id="actors-save">Save</button></div>
</div></div>`;
document.body.insertAdjacentHTML('beforeend', actorsModalHtml);
document.getElementById('btnActors').addEventListener('click', ()=>{
  document.getElementById('actors-json').value = JSON.stringify(actorMap, null, 2);
  document.getElementById('actors').style.display='flex';
});
document.getElementById('actors-save').addEventListener('click', ()=>{
  try{
    const parsed = JSON.parse(document.getElementById('actors-json').value);
    Object.keys(parsed).forEach(k=>{ actorMap[k]=parsed[k]; });
    document.getElementById('actors').style.display='none';
    openSub('Actor Mapping','Actor mappings saved.',200);
  }catch(e){ showErr(e); }
});
const profilesModalHtml = `
<div id="profiles" class="action" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center"><b>Manage Role Profiles</b><div><button class="btn" id="btnNewProfile">New</button><button class="btn" id="btnExportProfiles">Export</button><button class="btn" id="btnImportProfiles">Import</button><button class="btn" onclick="document.getElementById('profiles').style.display='none'">Close</button></div></div><hr style="border-color:#1b2450">
  <input type="file" id="profiles-file" style="display:none" accept="application/json">
  <div id="profiles-list" style="margin-bottom:12px"></div>
  <div id="profiles-form" style="display:none">
    <div class="fld"><label>Title</label><input id="pf_title" type="text"></div>
    <div class="fld"><label>Name</label><input id="pf_name" type="text"></div>
    <div class="fld"><label>Position</label><input id="pf_position" type="text"></div>
    <div class="fld"><label>Role</label><select id="pf_role"><option>SPONSOR</option><option>AUDIT</option><option>ECA</option><option>BANK</option><option>TREASURY</option><option>PLATFORM</option><option>MINISTRY</option><option>CONTRACTOR</option><option>REINSURER</option><option>INSURER</option><option>ECIC</option></select></div>
    <div class="fld"><label>Company</label><input id="pf_company" type="text"></div>
    <div class="fld"><label>Contact nr</label><input id="pf_contact" type="text"></div>
    <div class="fld"><label>Email</label><input id="pf_email" type="text"></div>
    <div class="fld"><label>Notes</label><input id="pf_notes" type="text"></div>
    <div style="display:flex;justify-content:flex-end"><button class="btn" id="pf_save">Save</button></div>
  </div>
</div></div>`;
document.body.insertAdjacentHTML('beforeend', profilesModalHtml);
const headerRow = document.querySelector('.row .row');
const btnProfiles = document.createElement('button'); btnProfiles.className='btn'; btnProfiles.id='btnProfiles'; btnProfiles.textContent='Manage Profiles';
headerRow.appendChild(btnProfiles);
document.getElementById('btnProfiles').addEventListener('click', ()=>{ openProfilesModal(); });
const notificationsModalHtml = `
<div id="notifications" class="action" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center"><b>Notifications Log</b><div><button class="btn" id="notif-clear">Clear</button><button class="btn" id="notif-export">Export</button><button class="btn" onclick="document.getElementById('notifications').style.display='none'">Close</button></div></div><hr style="border-color:#1b2450">
  <div id="notif-body" style="max-height:480px;overflow:auto;margin-bottom:8px"></div>
</div></div>`;
document.body.insertAdjacentHTML('beforeend', notificationsModalHtml);

const btnNotifications = document.createElement('button'); btnNotifications.className='btn'; btnNotifications.id='btnNotifications'; btnNotifications.textContent='Notifications';
headerRow.appendChild(btnNotifications);

function renderNotificationsList(){
  const notifs = loadNotifications();
  if(!document.getElementById('notif-body')) return;
  const out = [];
  if(notifs.length === 0){
    out.push('<div style="opacity:.7;padding:8px">No notifications yet.</div>');
  } else {
    notifs.forEach((n, idx)=>{
      out.push(`<div style="border-bottom:1px solid #1b2450;padding:8px 0"><div style="display:flex;justify-content:space-between"><div><b style="color:#cfe7ff">${n.role}</b></div><span style="opacity:.6;font-size:12px">${n.t}</span></div><div style="margin-top:4px;opacity:.85">${n.msg}</div><div style="margin-top:4px;opacity:.7;font-size:12px">Action: ${n.action || '‚Äî'}</div></div>`);
    });
  }
  document.getElementById('notif-body').innerHTML = out.join('');
}

document.getElementById('btnNotifications').addEventListener('click', ()=>{ renderNotificationsList(); document.getElementById('notifications').style.display='flex'; });
document.getElementById('notif-clear').addEventListener('click', ()=>{ clearNotifications(); renderNotificationsList(); openSub('Cleared','Notifications cleared.',150); });
document.getElementById('notif-export').addEventListener('click', ()=>{
  const notifs = loadNotifications();
  const blob = new Blob([JSON.stringify(notifs, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sov_notifications_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
  openSub('Exported', `${notifs.length} notifications exported.`, 200);
});
let APP_VERSION = localStorage.getItem('SOV_APP_VERSION') || 'v4.1.1';
let APP_BUILD = localStorage.getItem('SOV_APP_BUILD') || '2025-11-12';
const CHANGELOG_KEY = 'SOV_CHANGELOG';
const DEFAULT_CHANGELOG = [
  { v: 'v3.3.6', d: '2025-11-12', note: 'Enhanced PDF formatting with multi-page support, pretty JSON printing, per-page headers/footers with block hash and page numbers. Added on-screen scannable QR overlay for block references using QR Server API. Added [QR] link next to each ledger entry.' },
  { v: 'v3.3.5', d: '2025-11-11', note: 'Consolidated feature set: sovereign trust checks, IndexedDB evidence persistence, profiles CRUD, actor mapping, CONTRACTOR step, PDF tracking, notifications and automated test runners.' },
  { v: 'v3.3.5.1', d: '2025-11-11', note: 'Added runtime changelog UI and persistence; ability to append changelog entries and export/import changelog.' }
];

function loadChangeLog(){ try{ const s = localStorage.getItem(CHANGELOG_KEY); if(!s){ localStorage.setItem(CHANGELOG_KEY, JSON.stringify(DEFAULT_CHANGELOG)); return DEFAULT_CHANGELOG.slice(); } return JSON.parse(s); }catch(e){ localStorage.setItem(CHANGELOG_KEY, JSON.stringify(DEFAULT_CHANGELOG)); return DEFAULT_CHANGELOG.slice(); } }
function saveChangeLog(arr){ localStorage.setItem(CHANGELOG_KEY, JSON.stringify(arr)); }
function renderChangeLogList(){ const cl = loadChangeLog(); if(!document.getElementById('changelog-body')) return; const out = cl.map(entry=>{
    return `<div style="border-bottom:1px solid #1b2450;padding:8px 0"><div style="display:flex;justify-content:space-between"><div><b>${entry.v}</b> <span style="opacity:.8;margin-left:8px">${entry.d}</span></div></div><div style="margin-top:6px;white-space:pre-wrap">${entry.note}</div></div>`;
  }).join(''); document.getElementById('changelog-body').innerHTML = out; }

const changelogModalHtml = `
<div id="changelog" class="action" aria-modal="true" role="dialog"><div class="inner">
  <div class="row" style="justify-content:space-between;align-items:center"><b>Version & Changelog</b><div><button class="btn" id="changelog-close">Close</button></div></div><hr style="border-color:#1b2450">
  <div id="changelog-body" style="max-height:420px;overflow:auto;margin-bottom:8px"></div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
    <input id="chg_ver" placeholder="version (e.g. v3.3.6)" style="background:#06102a;border:1px solid #263471;color:#cfe7ff;padding:6px;border-radius:6px;width:160px">
    <input id="chg_note" placeholder="short note" style="flex:1;min-width:240px;background:#06102a;border:1px solid #263471;color:#cfe7ff;padding:6px;border-radius:6px">
    <button class="btn" id="changelog-add">Add</button>
    <button class="btn" id="changelog-snapshot" style="background:#0e5c38;border-color:#17a86f">Snapshot & Version</button>
    <button class="btn" id="changelog-export">Export</button>
    <button class="btn" id="changelog-import">Import</button>
    <input type="file" id="changelog-file" style="display:none" accept="application/json">
  </div>
</div></div>`;
document.body.insertAdjacentHTML('beforeend', changelogModalHtml);
function updateVersionDisplay(){
  const title = document.getElementById('app-title');
  if(title) title.textContent = `SOVERNX ‚Äî ECA Transaction Simulation ${APP_VERSION}`;
  document.title = `SOVERNX ECA Demo ${APP_VERSION}`;
}
const verBtn = document.getElementById('btnVersion'); if(verBtn) verBtn.addEventListener('click', ()=>{ renderChangeLogList(); document.getElementById('changelog').style.display='flex'; });
const chClose = document.getElementById('changelog-close'); if(chClose) chClose.addEventListener('click', ()=>{ document.getElementById('changelog').style.display='none'; });
const chAdd = document.getElementById('changelog-add'); if(chAdd) chAdd.addEventListener('click', ()=>{
  const v = document.getElementById('chg_ver').value || APP_VERSION;
  const note = document.getElementById('chg_note').value || '';
  const d = new Date().toISOString().split('T')[0];
  const cl = loadChangeLog(); cl.unshift({v:d? v : APP_VERSION, d, note}); saveChangeLog(cl); renderChangeLogList(); document.getElementById('chg_note').value=''; document.getElementById('chg_ver').value='';
});
const chExp = document.getElementById('changelog-export'); if(chExp) chExp.addEventListener('click', ()=>{
  const data = loadChangeLog(); const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sov_changelog.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),5000);
});
const chImp = document.getElementById('changelog-import'); if(chImp) chImp.addEventListener('click', ()=>{ document.getElementById('changelog-file').click(); });
const chFile = document.getElementById('changelog-file'); if(chFile) chFile.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result); if(Array.isArray(parsed)){ saveChangeLog(parsed); renderChangeLogList(); openSub('Import','Changelog imported.',200); } else openSub('Import','Invalid changelog JSON.',200); }catch(err){ openSub('Import','Error reading file: '+err,200); } }; r.readAsText(f);
});

const chSnap = document.getElementById('changelog-snapshot'); if(chSnap) chSnap.addEventListener('click', snapshotAndVersion);
function autoLogChangeEntry(actor, action, blockHash){
  try{
    const cl = loadChangeLog();
    const now = new Date().toISOString().split('T')[0];
    const time = new Date().toLocaleTimeString();
    const note = `AUTO: ${actor} recorded ${action} [${blockHash.slice(0,10)}‚Ä¶]`;
    cl.unshift({ v: APP_VERSION, d: now, note, t: time, ledger_action: action, ledger_actor: actor, ledger_hash: blockHash });
    saveChangeLog(cl);
  }catch(e){ console.warn('autoLogChangeEntry error',e); }
}
function snapshotAndVersion(){
  try{
    const newVer = document.getElementById('chg_ver').value || ('v3.3.' + (Math.floor(Math.random()*100)));
    const snapNote = document.getElementById('chg_note').value || 'Release snapshot';
    if(!newVer || newVer === APP_VERSION){ openSub('Snapshot','Please enter a new version number.',200); return; }
    loadProfiles();
    const snapPayload = {
      version: newVer,
      prev_version: APP_VERSION,
      timestamp: new Date().toISOString(),
      snapshot_note: snapNote,
      stats: {
        approvals,
        docs,
        profiles_count: profiles.length,
        ledger_entries: ledger.length,
        checkpoint_hash: ledger.length > 0 ? ledger[ledger.length-1].hash : 'GENESIS'
      }
    };
    appendBlock('SYSTEM', 'VERSION_SNAPSHOT', snapPayload);
    const cl = loadChangeLog();
    const now = new Date().toISOString().split('T')[0];
    cl.unshift({ v: newVer, d: now, note: `SNAPSHOT: ${snapNote}`, snapshot: true, stats: snapPayload.stats });
    saveChangeLog(cl);
    APP_VERSION = newVer;
    APP_BUILD = now;
    localStorage.setItem('SOV_APP_VERSION', newVer);
    localStorage.setItem('SOV_APP_BUILD', now);
    updateVersionDisplay(); // refresh the version display on page
    const backup = {
      version: newVer,
      timestamp: snapPayload.timestamp,
      profiles: profiles,
      changelog: cl,
      ledger_stats: snapPayload.stats
    };
    const backupBlob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
    const backupUrl = URL.createObjectURL(backupBlob);
    const backupLink = document.createElement('a');
    backupLink.href = backupUrl;
    backupLink.download = `sov_snapshot_${newVer}_${snapPayload.timestamp.split('T')[0]}.json`;
    document.body.appendChild(backupLink);
    backupLink.click();
    backupLink.remove();
    setTimeout(() => URL.revokeObjectURL(backupUrl), 5000);
    const htmlContent = document.documentElement.outerHTML;
    const updatedHtml = htmlContent.replace(
      /APP_VERSION = '[\w\.]+'/, 
      `APP_VERSION = '${newVer}'`
    ).replace(
      /APP_BUILD = '[\d\-]+'/, 
      `APP_BUILD = '${APP_BUILD}'`
    ).replace(
      /v3\.3\.5/g, 
      newVer
    );
    
    const htmlBlob = new Blob([updatedHtml], {type: 'text/html'});
    const htmlUrl = URL.createObjectURL(htmlBlob);
    const htmlLink = document.createElement('a');
    htmlLink.href = htmlUrl;
    htmlLink.download = `SOVERNX_ECA_Demo_${newVer}.html`;
    document.body.appendChild(htmlLink);
    htmlLink.click();
    htmlLink.remove();
    setTimeout(() => URL.revokeObjectURL(htmlUrl), 5000);
    document.getElementById('chg_ver').value = '';
    document.getElementById('chg_note').value = '';
    renderChangeLogList();
    
    openSub('Snapshot Created', `Version bumped to ${newVer}. Backup snapshot and updated HTML downloaded.`, 300);
  }catch(e){ showErr(e); console.warn('snapshotAndVersion',e); }
}

function renderProfilesList(){
  loadProfiles();
  const out=[];
  if(profiles.length===0) out.push('<div style="opacity:.8">No profiles yet. Click New to add.</div>');
  profiles.forEach(p=>{
    out.push(`<div style="border-bottom:1px solid #1b2450;padding:6px 0"><b>${p.name}</b> (${p.role}) ‚Ä¢ ${p.company} ‚Ä¢ ${p.contact||''} ‚Ä¢ ${p.email||''} <div style="float:right"><button class="btn" data-id="${p.id}" data-act="edit">Edit</button> <button class="btn" data-id="${p.id}" data-act="del">Delete</button></div></div>`);
  });
  document.getElementById('profiles-list').innerHTML = out.join('');
  document.querySelectorAll('#profiles-list button').forEach(b=> b.addEventListener('click', (e)=>{ const id=b.dataset.id; if(b.dataset.act==='edit') openProfileModal(id); else { profiles=profiles.filter(x=>x.id!==id); saveProfiles(); renderProfilesList(); } }));
}

function openProfilesModal(){ document.getElementById('profiles').style.display='flex'; renderProfilesList(); document.getElementById('profiles-form').style.display='none'; }
function openProfileModal(id){ document.getElementById('profiles-form').style.display='block'; if(id){ const p=profiles.find(x=>x.id===id); if(p){ document.getElementById('pf_title').value=p.title||''; document.getElementById('pf_name').value=p.name||''; document.getElementById('pf_position').value=p.position||''; document.getElementById('pf_role').value=p.role||''; document.getElementById('pf_company').value=p.company||''; document.getElementById('pf_contact').value=p.contact||''; document.getElementById('pf_email').value=p.email||''; document.getElementById('pf_notes').value=p.notes||''; document.getElementById('pf_save').dataset.id=id; } } else { document.getElementById('pf_title').value=''; document.getElementById('pf_name').value=''; document.getElementById('pf_position').value=''; document.getElementById('pf_role').value='SPONSOR'; document.getElementById('pf_company').value=''; document.getElementById('pf_contact').value=''; document.getElementById('pf_email').value=''; document.getElementById('pf_notes').value=''; document.getElementById('pf_save').dataset.id=''; } }
document.getElementById('btnNewProfile').addEventListener('click', ()=> openProfileModal());
document.getElementById('pf_save').addEventListener('click', ()=>{
  const id = document.getElementById('pf_save').dataset.id || newProfileId();
  const rec = { id, title:document.getElementById('pf_title').value, name:document.getElementById('pf_name').value, position:document.getElementById('pf_position').value, role:document.getElementById('pf_role').value, company:document.getElementById('pf_company').value, contact:document.getElementById('pf_contact').value, email:document.getElementById('pf_email').value, notes:document.getElementById('pf_notes').value };
  const idx = profiles.findIndex(p=>p.id===id);
  if(idx>=0) profiles[idx]=rec; else profiles.push(rec);
  saveProfiles(); renderProfilesList(); document.getElementById('profiles-form').style.display='none';
});
function exportProfiles(){
  try{
    loadProfiles();
    const data = profiles.map(p=>({ id:p.id, title:p.title, name:p.name, position:p.position, role:p.role, company:p.company, contact:p.contact, email:p.email, notes:p.notes }));
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sov_profiles_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    openSub('Exported', `${data.length} profiles exported.`, 200);
  }catch(e){ showErr(e); }
}

function importProfiles(){
  document.getElementById('profiles-file').click();
}

document.getElementById('btnExportProfiles').addEventListener('click', exportProfiles);
document.getElementById('btnImportProfiles').addEventListener('click', importProfiles);
document.getElementById('profiles-file').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const parsed = JSON.parse(r.result);
      if(Array.isArray(parsed)){
        loadProfiles();
        const existing = new Map(profiles.map(p=>[p.id, p]));
        parsed.forEach(p=>{
          if(p.id && !existing.has(p.id)){
            profiles.push(p);
          } else if(p.id && existing.has(p.id)){
            console.log('skipping existing profile:', p.id);
          } else if(!p.id){
            p.id = newProfileId();
            profiles.push(p);
          }
        });
        saveProfiles();
        renderProfilesList();
        openSub('Import', `Profiles imported. New profiles added; duplicates skipped.`, 250);
      } else {
        openSub('Import', 'Invalid profiles JSON (expected array).', 200);
      }
    }catch(err){
      openSub('Import', 'Error reading file: ' + err.message, 200);
    }
  };
  r.readAsText(f);
  e.target.value = ''; // reset input
});
const btnAuto = document.createElement('button'); btnAuto.className='btn'; btnAuto.id='btnAutoTest'; btnAuto.textContent='Run Auto Tests';
const btnTestPlan = document.createElement('button'); btnTestPlan.className='btn'; btnTestPlan.id='btnTestPlan'; btnTestPlan.textContent='Show Test Plan';

headerRow.appendChild(btnAuto);
headerRow.appendChild(btnTestPlan);
const btnChecks = document.createElement('button'); btnChecks.className='btn'; btnChecks.id='btnChecks'; btnChecks.textContent='Sovereign Checks';
headerRow.appendChild(btnChecks);
const btnUIAuto = document.createElement('button'); btnUIAuto.className='btn'; btnUIAuto.id='btnUIAuto'; btnUIAuto.textContent='Run Interactive Tests (UI)';
headerRow.appendChild(btnUIAuto);
async function exportAllFiles(){
  try{
    const db = await openFileDB();
    const tx = db.transaction('files', 'readonly');
    const store = tx.objectStore('files');
    const allFiles = await new Promise((res, rej)=>{
      const req = store.getAll();
      req.onsuccess = e => res(req.result);
      req.onerror = e => rej(e);
    });
    
    if(allFiles.length === 0){
      openSub('Export Files', 'No files in storage.', 200);
      return;
    }
    
    const exportData = [];
    for(const file of allFiles){
      const reader = new FileReader();
      const b64 = await new Promise((res, rej)=>{
        reader.onload = e => res(reader.result.split(',')[1]);
        reader.onerror = e => rej(e);
        reader.readAsDataURL(file.blob);
      });
      exportData.push({
        id: file.id,
        name: file.name,
        type: file.type,
        size: file.size,
        data: b64
      });
    }
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sov_evidence_files_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    openSub('Export', `${exportData.length} files exported.`, 200);
  }catch(e){ showErr(e); console.warn('exportAllFiles error', e); }
}

async function deleteFileById(id){
  try{
    const db = await openFileDB();
    const tx = db.transaction('files', 'readwrite');
    const store = tx.objectStore('files');
    const req = store.delete(id);
    await new Promise((res, rej)=>{
      req.onsuccess = e => res();
      req.onerror = e => rej(e);
    });
    openSub('Deleted', `File #${id} deleted.`, 150);
  }catch(e){ showErr(e); console.warn('deleteFileById error', e); }
}

async function runAutomatedTests(){
  try{
    const results = [];
    if(!project){ appendBlock('TEST','AUTO_CREATE_PROJECT',{id:'PRJ-TEST',name:'AutoTest Project'}); }
    results.push( sovereignCheckAuto('Reinsurance Mou','AUDIT', true, 'Auto pass') );
    results.push( sovereignCheckAuto('Cover & Policy','AUDIT', true, 'Auto pass') );
    results.push( sovereignCheckAuto('ECA Insurance Policy','AUDIT', false, 'Auto fail to test blocking') );
    results.push( sovereignCheckAuto('Lending Facility Agreements','BANK', true, 'Auto pass') );
    results.push( sovereignCheckAuto('Treasury Note','TREASURY', true, 'Auto pass') );
    results.push( sovereignCheckAuto('Sovereign Agreement','TREASURY', true, 'Auto pass') );
    const summary = results.map(r=>`${r.doc}: ${r.result}`).join('\n');
    await openSub('Automated Test Results', `<pre style="white-space:pre-wrap">${summary}</pre>`, 400);
    openSub('Automated Test Results','Tests complete. Review ledger for SOV_TRUST_CHECK entries.',200);
  }catch(e){ showErr(e); }
}
document.getElementById('btnAutoTest').addEventListener('click', runAutomatedTests);
document.getElementById('btnTestPlan').addEventListener('click', ()=>{
  const plan = `Test plan:\n\n1) Create Project (btn1) ‚Äî fill project details and submit. Expect: CREATE_PROJECT ledger entry and project PDF.\n\n2) Data Room (btn2) ‚Äî test attaching files and submitting. Expect: CONFIRM_DATA_ROOM ledger entry, files listed in #docs, and DataRoom PDF.\n\n3) Interface (btn3) ‚Äî on submit, Sovereign Trust Check for Reinsurance MoU should appear; test PASS and FAIL paths. Expect SOV_TRUST_CHECK ledger entries and PDF audit trail.\n\n4) Steps 4‚Äì11 ‚Äî for each step that issues key documents, the sovereign check modal will appear (per mapping). Test both passing and failing the checks and verify ledger entries and PDFs.\n\n5) Dashboard ‚Äî open Dashboard, click Last Action links to open PDFs or JSON blocks.\n\n6) Evidence persistence ‚Äî attach files in a sovereign check, then reload the page and use the Dashboard/Docs links to confirm persistence (files stored in IndexedDB are available in the session).`;
  openSub('Automated Test Plan', `<pre style="white-space:pre-wrap">${plan}</pre>`, 200);
});
document.getElementById('btnChecks').addEventListener('click', async ()=>{
  try{
    const rows=[];
    rows.push('<table style="width:100%;border-collapse:collapse"><tr><th>i</th><th>Time</th><th>Actor</th><th>Doc</th><th>Result</th><th>Evidence</th><th>Actions</th></tr>');
    const checks = ledger.filter(b=>b.action==='SOV_TRUST_CHECK');
    for(const c of checks){
      const payload = c.payload||{};
      let evHtml='‚Äî';
      let fileIds = [];
      if(payload.fileIds && payload.fileIds.length){
        const parts = [];
        for(const id of payload.fileIds){ 
          try{ 
            const url = await getFileURLById(id); 
            if(url) parts.push(`<a class="doclink" href="${url}" target="_blank">file#${id}</a>`); 
            fileIds.push(id);
          }catch(e){ parts.push(`file#${id}`); fileIds.push(id); } 
        }
        evHtml = parts.join(' ');
      }
      const actionsHtml = fileIds.map(fid => `<button class="btn" style="font-size:11px;padding:4px 6px;margin:2px" onclick="deleteFileById(${fid})">Del#${fid}</button>`).join('');
      rows.push(`<tr><td>${c.i}</td><td>${c.t}</td><td>${c.actor}</td><td>${payload.doc||'‚Äî'}</td><td>${payload.result||'‚Äî'}</td><td style="opacity:.9">${evHtml}</td><td>${actionsHtml}</td></tr>`);
    }
    rows.push('</table>');
    const body = `<div>${rows.join('')}</div><div style="margin-top:12px"><button class="btn" onclick="exportAllFiles()">Export All Files</button></div>`;
    await openSub('SOVEREIGN CHECKS ‚Äî Audit View', body, 200);
  }catch(e){ showErr(e); }
});
let autoTestMode = false;
const origOpenAction = openAction;
function autoFillCurrentAction(title, fields){
  try{
    const inputs = $$('#act-body input');
    inputs.forEach(i=>{
      if(i.type==='checkbox') { i.checked = true; i.dispatchEvent(new Event('input',{bubbles:true})); }
      else if(i.type==='file'){
        try{
          const f = new File([`Auto evidence for ${title}`], `evidence-${Date.now()}.txt`, {type:'text/plain'});
          const dt = new DataTransfer(); dt.items.add(f); i.files = dt.files; i.dispatchEvent(new Event('input',{bubbles:true}));
        }catch(e){ console.warn('auto attach failed',e); }
      }
      else { i.value = i.value || ('AUTO'); i.dispatchEvent(new Event('input',{bubbles:true})); }
    });
    const btn = document.getElementById('act-submit'); if(btn && !btn.disabled) btn.click(); else { const fbtn=document.getElementById('act-force'); if(fbtn) fbtn.click(); }
  }catch(e){ console.warn('autoFillCurrentAction',e); }
}
openAction = function(title, fields){
  const p = origOpenAction(title, fields);
  if(autoTestMode){ setTimeout(()=> autoFillCurrentAction(title, fields), 200); }
  return p;
};

function waitForLedgerIncrease(prevLen, timeout=8000){ return new Promise((res,rej)=>{ const start=Date.now(); const iv=setInterval(()=>{ if(ledger.length>prevLen){ clearInterval(iv); return res(true); } if(Date.now()-start>timeout){ clearInterval(iv); return res(false); } },100); }); }

async function runInteractiveUITests(){
  try{
    autoTestMode = true;
    const sequence = ['#btn1','#btn2','#btn3','#btn4','#btn5','#btn6','#btn7','#btn8','#btn9','#btn10','#btn11'];
    let prev=ledger.length;
    for(const s of sequence){
      const el = document.querySelector(s); if(!el) continue;
      el.click();
      const ok = await waitForLedgerIncrease(prev, 10000);
      prev = ledger.length;
      await new Promise(r=>setTimeout(r,300));
    }
    autoTestMode = false;
    await openSub('Interactive Tests','UI-driven tests complete. Review ledger and docs.',300);
  }catch(e){ showErr(e); autoTestMode=false; }
}
document.getElementById('btnUIAuto').addEventListener('click', runInteractiveUITests);
async function sovereignCheck(docName, actor='AUDIT'){
  const vals = await openAction(`SOVEREIGN TRUST CHECK ‚Äî ${docName}`,[
    {name:'veracity',label:'Veracity (correct legal document)',type:'checkbox',value:false,required:true},
    {name:'compliance',label:'Compliance (meets requirements)',type:'checkbox',value:false,required:true},
    {name:'accountability',label:'Accountability (stakeholder approvals obtained)',type:'text',value:'',required:true},
    {name:'authorisation',label:'Authorisation (official sign‚Äëoff name/role)',type:'text',value:'',required:true},
    {name:'finalApproval',label:'Final Approval (all CPs met)',type:'checkbox',value:false,required:true},
    {name:'notes',label:'Notes (optional)',type:'text',value:''},
    {name:'evidence',label:'Attach Evidence (optional)',type:'file',multiple:true,accept:'.pdf,.doc,.docx,.xlsx,.xls,.jpg,.png'}
  ]);
  if(!vals) return null; // user cancelled
  let savedFiles = [];
  if(vals.__files__ && vals.__files__.evidence && vals.__files__.evidence.length){
    try{ savedFiles = await saveFilesToDB(vals.__files__.evidence); }catch(e){ console.warn('file save failed',e); }
  }
  if(savedFiles.length){
    savedFiles.forEach(f=>{ const a=document.createElement('a'); a.className='doclink'; a.textContent=`üìÅ ${f.name} (${(f.size/1024).toFixed(1)}KB)`; a.href=f.url; a.download=f.name; a.title=f.type; $('#docs').appendChild(a); docs++; });
    updateInsights();
  } else if(vals.evidence?.length){
    vals.evidence.forEach(f=>{ const a=document.createElement('a'); a.className='doclink'; a.textContent=`üìÅ ${f.name} (${(f.size/1024).toFixed(1)}KB)`; a.title=f.type; $('#docs').appendChild(a); docs++; }); updateInsights();
  }

  const passed = !!(vals.veracity && vals.compliance && vals.finalApproval && vals.accountability && vals.authorisation);
  const payload = {doc:docName, actor, result: passed ? 'PASS' : 'FAIL', checks:{veracity:!!vals.veracity, compliance:!!vals.compliance, accountability:vals.accountability, authorisation:vals.authorisation, finalApproval:!!vals.finalApproval, notes:vals.notes}};
  if(savedFiles.length){ payload.fileIds = savedFiles.map(f=>f.id); }
  const blkSov = appendBlock(actor,'SOV_TRUST_CHECK',payload);
  try{ makePDF(`${(project&&project.id)||'PROJECT'}-SOV_TRUST_${docName.replace(/\s+/g,'_')}.pdf`, `SOVEREIGN TRUST CHECK ‚Ä¢ ${docName}`, [`Document: ${docName}`, `Result: ${payload.result}`, `Accountability: ${payload.checks.accountability}`, `Authorisation: ${payload.checks.authorisation}`, `Notes: ${payload.checks.notes||'‚Äî'}`], blkSov.hash); }catch(e){/*non‚Äëfatal*/}

  return {...payload, passed};
}
function markDone(key){ completed[key]=true; stepDone(key); }

$('#btn1').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn1'); stepActive('CREATE'); insights.stage='Create Project'; updateInsights();
  currentActionActors = actorMap.CREATE;
  const vals = await openAction('Create Project',[
      {name:'name',label:'Project Name',value:'Riverview Solar 25MW',required:true},
      {name:'valueUSD',label:'Value (USD)',type:'number',value:'10000000',required:true},
      {name:'tenor',label:'Tenor (months)',type:'number',value:'60',required:true},
      {name:'risk',label:'Risk',value:'A-',required:true},
      {name:'country',label:'Country',value:'ZA',required:true},
    ]);
    if(!vals) return;
    project={id:'PRJ-001',name:vals.name,valueUSD:+vals.valueUSD,tenor:+vals.tenor,risk:vals.risk,country:vals.country};
    $('#p-title').textContent=project.name;
    $('#p-meta').textContent=`Value ${project.valueUSD.toLocaleString()} | Tenor ${project.tenor}m | Risk ${project.risk} | Country ${project.country}`;
  const blk1 = appendBlock('SPONSOR','CREATE_PROJECT',project);
  makePDF(`${project.id}-01_Project_Intake.pdf`,'STEP 1 ‚Ä¢ Project Intake ‚Ä¢ COMPLETED',[`Project: ${project.name}`,`Value: ${project.valueUSD}`,`Tenor: ${project.tenor}`,`Risk: ${project.risk}`,`Country: ${project.country}`], blk1.hash);
    doneBtn('#btn1'); markDone('CREATE'); enable('#btn2');
    applyRole(); // Re-apply role filtering to enable subsequent buttons now that project exists
  }catch(e){ showErr(e); }
});

$('#btn2').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn2'); stepActive('DOCS'); insights.stage='Data Room'; updateInsights();
  currentActionActors = actorMap.DOCS;
  const vals = await openAction('Data Room: Confirm Documents',[
      {name:'kyc',label:'KYC/AML (tick)',type:'checkbox',value:true,required:true},
      {name:'epc',label:'EPC Contract (tick)',type:'checkbox',value:true,required:true},
      {name:'esg',label:'ESG/ESIA (tick)',type:'checkbox',value:true,required:true},
      {name:'ts',label:'Term Sheet (tick)',type:'checkbox',value:true,required:true},
      {name:'docs',label:'Upload Supporting Documents (optional)',type:'file',multiple:true,accept:'.pdf,.doc,.docx,.xlsx,.xls,.jpg,.png'},
    ]);
    if(!vals) return;
    if(vals.docs?.length > 0){
      vals.docs.forEach(doc=>{
        const a=document.createElement('a');
        a.className='doclink';
        a.textContent=`üìÑ ${doc.name} (${(doc.size/1024).toFixed(1)}KB)`;
        a.title=`${doc.type}`;
        $('#docs').appendChild(a);
        docs++;
      });
      updateInsights();
    }
    const legerVals = {...vals};
    delete legerVals.docs;
  const blk2 = appendBlock('AUDIT','CONFIRM_DATA_ROOM',legerVals);
    let docsList = Object.keys(vals).filter(k=>vals[k]&&k!=='docs').join(', ');
    if(vals.docs?.length) docsList += `; Uploaded ${vals.docs.length} file(s)`;
  makePDF(`${project.id}-02_DataRoom_Confirmation.pdf`,'STEP 2 ‚Ä¢ Data Room ‚Ä¢ COMPLETED',[`Docs: ${docsList}`], blk2.hash);
    doneBtn('#btn2'); markDone('DOCS'); enable('#btn3');
  }catch(e){ showErr(e); }
});

$('#btn3').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn3'); stepActive('INTERFACE'); insights.stage='Interface'; updateInsights();
  currentActionActors = actorMap.INTERFACE;
  const vals = await openAction('Project Interface (ECA)',[
      {name:'eca',label:'ECA Name',value:'Kinfedi ECA',required:true},
      {name:'prem',label:'ECA Premium (%)',type:'number',value:'1.5',required:true},
      {name:'room',label:'Data Room',value:'S3/SOVERNX/PRJ-001/',required:true},
      {name:'site',label:'Site Info',value:'GPS:-33.93,18.42 | Western Cape',required:true},
      {name:'mou',label:'Reinsurance MoU',value:'GlobalRe Layer up to 40%',required:true},
    ]);
    if(!vals) return;
    const sc = await sovereignCheck('Reinsurance Mou','AUDIT');
    if(sc===null) return; // cancelled
    if(!sc.passed){ await openSub('SOVEREIGN TRUST CHECK','Reinsurance MoU check did not pass. Cannot proceed until checks pass.',300); return; }
  const blk3 = appendBlock('ECA','SAVE_INTERFACE',vals);
  makePDF(`${project.id}-03_Project_Interface.pdf`,'STEP 3 ‚Ä¢ Project Interface ‚Ä¢ COMPLETED',[`ECA: ${vals.eca}`,`Premium: ${vals.prem}%`], blk3.hash);
    doneBtn('#btn3'); markDone('INTERFACE'); enable('#btn4');
  }catch(e){ showErr(e); }
});

$('#btn4').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn4'); stepActive('ENGINE'); insights.stage='Project Due Dilligence'; updateInsights();
  currentActionActors = actorMap.ENGINE;
  const vals = await openAction('Project Due Dilligence',[
      {name:'tech',label:'Tech/Legal (tick)',type:'checkbox',value:true,required:true},
      {name:'model',label:'Financial Model (tick)',type:'checkbox',value:true,required:true},
      {name:'esia',label:'ESIA/KYC (tick)',type:'checkbox',value:true,required:true},
      {name:'docs',label:'Upload Supporting Documents (optional)',type:'file',multiple:true,accept:'.pdf,.doc,.docx,.xlsx,.xls,.jpg,.png,.pptx'},
    ]);
    if(!vals) return;
    if(vals.docs?.length > 0){
      vals.docs.forEach(doc=>{
        const a=document.createElement('a');
        a.className='doclink';
        a.textContent=`üìÑ ${doc.name} (${(doc.size/1024).toFixed(1)}KB)`;
        a.title=`${doc.type}`;
        $('#docs').appendChild(a);
        docs++;
      });
      updateInsights();
    }
    const legerVals = {...vals};
    delete legerVals.docs;
  const blk4 = appendBlock('ENGINE','RUN_PIPELINE',legerVals);
    let docsList = Object.keys(vals).filter(k=>vals[k]&&k!=='docs').join(', ');
    if(vals.docs?.length) docsList += `; Uploaded ${vals.docs.length} file(s)`;
  makePDF(`${project.id}-04_Project_Due_Dilligence_Report.pdf`,'STEP 4 ‚Ä¢ Project Due Dilligence ‚Ä¢ COMPLETED',[`Stages: Tech/Legal | Model | ESIA/KYC`,`Documents: ${docsList}`], blk4.hash);
    doneBtn('#btn4'); markDone('ENGINE'); enable('#btn5');
  }catch(e){ showErr(e); }
});

$('#btn5').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn5'); stepActive('DD_OUT'); insights.stage='DD Outputs'; updateInsights();
  currentActionActors = actorMap.DD_OUT;
  const vals = await openAction('Generate DD Outputs',[
      {name:'dd',label:'DD Report (tick)',type:'checkbox',value:true,required:true},
      {name:'audit',label:'Audited Model (tick)',type:'checkbox',value:true,required:true},
      {name:'esmp',label:'ESMP (tick)',type:'checkbox',value:true,required:true},
      {name:'cover',label:'Cover & Policy (tick)',type:'checkbox',value:true,required:true},
    ]);
    if(!vals) return;
  const blk5 = appendBlock('AUDIT','GENERATE_DD_OUTPUTS',vals);
    makePDF(`${project.id}-05_DD_Pack.pdf`,'STEP 5 ‚Ä¢ DD Outputs ‚Ä¢ COMPLETED',['DD | Audited Model | ESMP | Cover & Policy'], blk5.hash);
    doneBtn('#btn5'); markDone('DD_OUT'); enable('#btn6');
  }catch(e){ showErr(e); }
});
function drawRiskCanvas(id, mu=0, sigma=1){
  const c=document.getElementById(id),x=c.getContext('2d'); const w=c.width=c.clientWidth,h=c.height=c.clientHeight;
  x.clearRect(0,0,w,h); x.strokeStyle='#cfe7ff'; x.beginPath(); x.moveTo(40,h-30); x.lineTo(w-10,h-30); x.moveTo(40,h-30); x.lineTo(40,10); x.stroke();
  x.strokeStyle='#12b0a2'; x.beginPath();
  for(let X=-3;X<=3;X+=0.02){ const y=(1/(Math.sqrt(2*Math.PI)*sigma))*Math.exp(-((X-mu)**2)/(2*sigma*sigma));
    const px=40+(X+3)/6*(w-60), py=(h-30)-y/0.4*(h-60); if(X===-3) x.moveTo(px,py); else x.lineTo(px,py); }
  x.stroke();
}
function drawPricing(lineId,sId,base=1.5,fees=0.25,load=0.4){
  let c=document.getElementById(lineId),x=c.getContext('2d'); let w=c.width=c.clientWidth,h=c.height=c.clientHeight;
  x.clearRect(0,0,w,h); x.strokeStyle='#cfe7ff'; x.beginPath(); x.moveTo(40,h-30); x.lineTo(w-10,h-30); x.moveTo(40,h-30); x.lineTo(40,10); x.stroke();
  x.strokeStyle='#12b0a2'; x.beginPath();
  for(let i=0;i<=100;i++){ const t=i/100, y=base + (load*Math.sin(t*2.5)) + (fees*0.1*t); const px=40+t*(w-60),py=(h-30)-y/4*(h-60); if(i===0)x.moveTo(px,py); else x.lineTo(px,py);} x.stroke();
  c=document.getElementById(sId); x=c.getContext('2d'); w=c.width=c.clientWidth; h=c.height=c.clientHeight;
  x.clearRect(0,0,w,h); x.strokeStyle='#cfe7ff'; x.beginPath(); x.moveTo(40,h-30); x.lineTo(w-10,h-30); x.moveTo(40,h-30); x.lineTo(40,10); x.stroke();
  x.strokeStyle='#ffb020'; x.beginPath();
  for(let i=0;i<=100;i++){ const t=i/100, y=1/(1+Math.exp(-10*(t-0.5))); const px=40+t*(w-60),py=(h-30)-y*(h-60); if(i===0)x.moveTo(px,py); else x.lineTo(px,py);} x.stroke();
}
$('#btn6').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn6'); stepActive('ECA_PRICING'); insights.stage='ECA Pricing & Reinsurance'; updateInsights();
    currentActionActors = actorMap.ECA_PRICING;
    // Set callback to animate spinners during Risk Modeling display
    openSub.initCallback = (duration) => {
      setTimeout(() => initializeProcessingSpinners(document.getElementById('sub-body'), duration), 50);
    };
    await openSub('SOVERNX RISK MODELER ‚Äî Risk Modeling', displayRiskModelingProcessing(), 5000);
    await openSub('SOVERNX RISK MODELER ‚Äî Risk Modeling', `
      <div class="fld"><label>Expected Loss (mu)</label><input id="mu" type="number" value="0" step="0.1"></div>
      <div class="fld"><label>Volatility (sigma)</label><input id="sigma" type="number" value="1" step="0.1"></div>
      <div class="fld"><label>Attachment Point (USD)</label><input id="attach" type="number" value="2000000"></div>
      <div class="fld"><label>Limit (USD)</label><input id="limit" type="number" value="4000000"></div>
      <canvas id="riskC"></canvas>
    `, 400);
    drawRiskCanvas('riskC', Number($('#mu').value||0), Number($('#sigma').value||1));
    // Set callback to animate spinners during Pricing display
    openSub.initCallback = (duration) => {
      setTimeout(() => initializeProcessingSpinners(document.getElementById('sub-body'), duration), 50);
    };
    await openSub('SOVERNX PRICING TOOL ‚Äî Pricing Exercise', displayPricingProcessing(), 5000);
    await openSub('SOVERNX PRICING TOOL ‚Äî Pricing Exercise', `
      <div class="fld"><label>Base Premium %</label><input id="base" type="number" value="1.5" step="0.05"></div>
      <div class="fld"><label>Fees %</label><input id="fees" type="number" value="0.25" step="0.05"></div>
      <div class="fld"><label>Reins Load %</label><input id="load" type="number" value="0.40" step="0.05"></div>
      <canvas id="pl"></canvas><div style="height:8px"></div><canvas id="ps"></canvas>
    `, 400);
    drawPricing('pl','ps', Number($('#base')?.value||1.5), Number($('#fees')?.value||0.25), Number($('#load')?.value||0.4));
    await openSub('Reinsurance Placement', `
      <p>Proposed layers:</p>
      <ul>
        <li>Layer 1: USD 2,000,000 @ 0.95%</li>
        <li>Layer 2: USD 1,500,000 @ 1.10%</li>
        <li>Layer 3: USD 500,000 @ 1.35%</li>
      </ul>
      <p>Total placed: <b>USD 4,000,000</b> ‚Ä¢ Blended rate <b>1.15%</b></p>
    `, 300);
    const placed=4000000, blended=1.15;
    insights.prem = Number($('#base')?.value||1.5) + Number($('#fees')?.value||0.25) + Number($('#load')?.value||0.4);
    insights.reins = placed; updateInsights();
    const blk6 = appendBlock('ECA','RUN_PRICING_AND_REI_DEMO',{
      risk:{mu:Number($('#mu')?.value),sigma:Number($('#sigma')?.value),attach:Number($('#attach')?.value),limit:Number($('#limit')?.value)},
      pricing:{base:Number($('#base')?.value),fees:Number($('#fees')?.value),load:Number($('#load')?.value)},
      reinsurance:{placed, blended}
    });
    makePDF(`${project.id}-06_Pricing_Risk_Reinsurance.pdf`,'STEP 6 ‚Ä¢ Pricing & Reinsurance ‚Ä¢ COMPLETED',[
      `Risk: mu=${$('#mu')?.value} sigma=${$('#sigma')?.value} attach=${$('#attach')?.value} limit=${$('#limit')?.value}`,
      `Pricing: base=${$('#base')?.value}% fees=${$('#fees')?.value}% load=${$('#load')?.value}%`,
      `Reinsurance: placed=${placed.toLocaleString()} @ ${blended}%`
    ], blk6.hash);
    doneBtn('#btn6'); markDone('ECA_PRICING'); enable('#btn7');
  }catch(e){ showErr(e); }
});

$('#btn7').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn7'); stepActive('POLICY_OUT'); insights.stage='Policy & Slip'; updateInsights();
  currentActionActors = actorMap.POLICY_OUT;
  const vals = await openAction('Generate Policy Draft & Slip',[
      {name:'policy',label:'Policy Draft (tick)',type:'checkbox',value:true,required:true},
      {name:'cover',label:'ECA Cover Approval (tick)',type:'checkbox',value:true,required:true},
      {name:'slip',label:'Slip + Treasury Note (tick)',type:'checkbox',value:true,required:true},
    ]);
    if(!vals) return;
    const scCover = await sovereignCheck('Cover & Policy','AUDIT'); if(scCover===null) return; if(!scCover.passed){ await openSub('SOVEREIGN TRUST CHECK','Cover & Policy check failed. Cannot proceed.',300); return; }
    const scEca = await sovereignCheck('ECA Insurance Policy','AUDIT'); if(scEca===null) return; if(!scEca.passed){ await openSub('SOVEREIGN TRUST CHECK','ECA Insurance Policy check failed. Cannot proceed.',300); return; }
  const blk7 = appendBlock('ECA','POLICY_AND_SLIP',vals);
  makePDF(`${project.id}-07_Policy_and_Slip.pdf`,'STEP 7 ‚Ä¢ Policy & Slip ‚Ä¢ COMPLETED',['Policy | Cover | Slip+Treasury'], blk7.hash);
    doneBtn('#btn7'); markDone('POLICY_OUT'); enable('#btn8');
  }catch(e){ showErr(e); }
});

$('#btn8').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn8'); stepActive('CREDIT_COMMITTEE'); insights.stage='Credit Committee'; updateInsights();
  currentActionActors = actorMap.CREDIT_COMMITTEE;
  const vals = await openAction('Credit Committee Decision',[{name:'approval',label:'Approval %',type:'number',value:'100',required:true}]);
    if(!vals) return;
  const blk8 = appendBlock('BANK','CREDIT_COMMITTEE',vals);
  makePDF(`${project.id}-08_Credit_Memo.pdf`,'STEP 8 ‚Ä¢ Credit Committee ‚Ä¢ COMPLETED',[`Approval: ${vals.approval}%`], blk8.hash);
    doneBtn('#btn8'); markDone('CREDIT_COMMITTEE'); enable('#btn9');
  }catch(e){ showErr(e); }
});

$('#btn9').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn9'); stepActive('FACILITY'); insights.stage='Facility & LC/Guarantee'; updateInsights();
  currentActionActors = actorMap.FACILITY;
  const vals = await openAction('Issue Facility & LC/Guarantee',[
      {name:'lc',label:'LC/Guarantee (tick)',type:'checkbox',value:true,required:true},
      {name:'facility',label:'Facility Agreement (tick)',type:'checkbox',value:true,required:true},
      {name:'ts',label:'Term Sheet updated (tick)',type:'checkbox',value:true,required:true},
    ]);
    if(!vals) return;
    const scFac = await sovereignCheck('Lending Facility Agreements','BANK'); if(scFac===null) return; if(!scFac.passed){ await openSub('SOVEREIGN TRUST CHECK','Lending Facility Agreements check failed. Cannot proceed.',300); return; }
  const blk9 = appendBlock('BANK','ISSUE_FACILITY',vals);
  makePDF(`${project.id}-09_Facility_and_LC.pdf`,'STEP 9 ‚Ä¢ Facility & LC ‚Ä¢ COMPLETED',['Facility docs executed'], blk9.hash);
    doneBtn('#btn9'); markDone('FACILITY'); enable('#btn10');
  }catch(e){ showErr(e); }
});

$('#btn10').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn10'); stepActive('TREASURY'); insights.stage='Treasury Guarantee'; updateInsights();
  currentActionActors = actorMap.TREASURY;
  const vals = await openAction('Treasury Headroom & Guarantee',[{name:'head',label:'Headroom (USD m)',type:'number',value:'100',required:true}]);
    if(!vals) return;
    const scTN = await sovereignCheck('Treasury Note','TREASURY'); if(scTN===null) return; if(!scTN.passed){ await openSub('SOVEREIGN TRUST CHECK','Treasury Note check failed. Cannot proceed.',300); return; }
    const scSA = await sovereignCheck('Sovereign Agreement','TREASURY'); if(scSA===null) return; if(!scSA.passed){ await openSub('SOVEREIGN TRUST CHECK','Sovereign Agreement check failed. Cannot proceed.',300); return; }
    insights.head = Number(vals.head||0); updateInsights();
  const blk10 = appendBlock('TREASURY','ISSUE_SOV_GUARANTEE',vals);
  makePDF(`${project.id}-10_Sovereign_Guarantee.pdf`,'STEP 10 ‚Ä¢ Sovereign Guarantee ‚Ä¢ COMPLETED',[`Headroom: ${vals.head}m`], blk10.hash);
    doneBtn('#btn10'); markDone('TREASURY'); enable('#btn11');
  }catch(e){ showErr(e); }
});
async function evidenceIndex(fileLinks){
  const manifest = ['SOVERNX Evidence Pack', new Date().toLocaleString(), '', 'FILES:'].concat(fileLinks.map(h=>'- '+h)).join('\n');
  const blob = new Blob([manifest],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${(project&&project.id)||'PROJECT'}-EvidencePack.txt`; a.textContent='Download EvidencePack.txt'; a.className='doclink';
  $('#docs').appendChild(a);
}

$('#btn11').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn11'); stepActive('PAYMENT_PACK'); insights.stage='Ministry: Payment Pack'; updateInsights();
  currentActionActors = actorMap.PAYMENT_PACK;
  const vals = await openAction('Confirm EPC Sign & NTP',[
      {name:'epc',label:'EPC Signed (tick)',type:'checkbox',value:true,required:true},
      {name:'ntp',label:'NTP Issued (tick)',type:'checkbox',value:true,required:true},
    ]);
    if(!vals) return;
    const scNTP = await sovereignCheck('Notice to Proceed','MINISTRY'); if(scNTP===null) return; if(!scNTP.passed){ await openSub('SOVEREIGN TRUST CHECK','Notice to Proceed check failed. Cannot proceed.',300); return; }
    if(vals.epc){ const scEPC = await sovereignCheck('EPC Contract','AUDIT'); if(scEPC===null) return; if(!scEPC.passed){ await openSub('SOVEREIGN TRUST CHECK','EPC Contract check failed. Cannot proceed.',300); return; } }
    const manifest={project, stages:ledger.map(b=>({actor:b.actor,action:b.action,hash:b.hash})), at:new Date().toISOString()};
    const blob=new Blob([JSON.stringify(manifest,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`${project.id}-11_PaymentPack.json`; a.textContent=`Download ${project.id}-11_PaymentPack.json`; a.className='doclink'; $('#docs').appendChild(a);
  const blk11 = appendBlock('MINISTRY','GENERATE_PAYMENT_PACK',{ok:true});
  makePDF(`${project.id}-11_PaymentPack_Receipt.pdf`,'STEP 11 ‚Ä¢ Ministry: Payment Pack ‚Ä¢ COMPLETED',['EPC ‚úî NTP ‚úî','JSON manifest generated'], blk11.hash);
    doneBtn('#btn11'); markDone('PAYMENT_PACK');
    const links=[...document.querySelectorAll('#docs a')].map(a=>a.download||a.textContent);
    evidenceIndex(links);
  }catch(e){ showErr(e); }
});
$('#btn12').addEventListener('click', async ()=>{
  try{
    progressBtn('#btn12'); stepActive('CONTRACTOR'); insights.stage='Contractor Fulfillment'; updateInsights();
    currentActionActors = actorMap.CONTRACTOR;
    const vals = await openAction('CONTRACTOR: Fulfillment of Project',[
      {name:'contractFile',label:'Turnkey Project Contract (upload)',type:'file',multiple:false,accept:'.pdf,.doc,.docx'},
      {name:'funding',label:'Funding Confirmed (USD)',type:'number',value:'0',required:true},
      {name:'partners',label:'Infrastructure Partners',type:'text',value:'',required:false},
      {name:'materials',label:'Infrastructure Materials',type:'text',value:'',required:false},
      {name:'services',label:'Infrastructure Services',type:'text',value:'',required:false},
      {name:'pm',label:'Project Management',type:'text',value:'',required:false},
      {name:'disb',label:'Disbursements',type:'text',value:'',required:false},
      {name:'onTime',label:'On Time (tick)',type:'checkbox',value:false,required:false},
      {name:'inBudget',label:'In Budget (tick)',type:'checkbox',value:false,required:false}
    ]);
    if(!vals) return;
    if(vals.__files__ && vals.__files__.contractFile && vals.__files__.contractFile.length){
      try{ const saved = await saveFilesToDB(vals.__files__.contractFile); saved.forEach(f=>{ const a=document.createElement('a'); a.className='doclink'; a.href=f.url; a.download=f.name; a.textContent=`üìÑ ${f.name}`; $('#docs').appendChild(a); docs++; }); updateInsights(); if(saved.length) vals.contractFileId = saved[0].id; }catch(e){ console.warn(e); }
    }
  const legerVals = {...vals}; delete legerVals.__files__;
  const blk12 = appendBlock('CONTRACTOR','FULFILL_PROJECT',legerVals);
  const status = `${vals.onTime? 'On Time':'Delayed'} ‚Ä¢ ${vals.inBudget? 'In Budget':'Over Budget'}`;
  makePDF(`${project.id}-12_Contractor_Fulfillment.pdf`,'STEP 12 ‚Ä¢ Contractor Fulfillment ‚Ä¢ COMPLETED',[`Funding: ${vals.funding}`,`Partners: ${vals.partners}`,`Materials: ${vals.materials}`,`Services: ${vals.services}`,`PM: ${vals.pm}`,`Disbursements: ${vals.disb}`,`Status: ${status}`], blk12.hash);
    doneBtn('#btn12'); markDone('CONTRACTOR');
  }catch(e){ showErr(e); }
});
const cachedVer = localStorage.getItem('SOV_APP_VERSION');
if(cachedVer && cachedVer !== 'v3.3.6'){
  localStorage.setItem('SOV_APP_VERSION', 'v3.3.6');
  localStorage.setItem('SOV_APP_BUILD', '2025-11-12');
  APP_VERSION = 'v3.3.6';
  APP_BUILD = '2025-11-12';
}
loadProfiles();
applyRole();
updateInsights();
updateVersionDisplay(); // refresh the version display after DOM is ready
</script>
<script>
(function(){
  const els = document.querySelectorAll('.version-tag,#version,.version');
  els.forEach(el=> el.textContent = 'v3.3.7 ¬∑ 2025-11-12 15:00');
})();

</script>
<script>
// Auto-increment version and render banner
(function(){
  try {
    var key = 'sovernxVersion';
    var base = 'v3.3.7';
    var current = localStorage.getItem(key) || base;
    // parse vX.Y.Z
    var m = /^v(\d+)\.(\d+)\.(\d+)$/.exec(current);
    var major=3, minor=3, patch=7;
    if (m) { major = parseInt(m[1]); minor = parseInt(m[2]); patch = parseInt(m[3]); }
    // bump patch
    patch += 1;
    var next = 'v' + major + '.' + minor + '.' + patch;
    localStorage.setItem(key, next);

    var now = new Date();
    var ts = now.getFullYear() + '-' +
             String(now.getMonth()+1).padStart(2,'0') + '-' +
             String(now.getDate()).padStart(2,'0') + ' ' +
             String(now.getHours()).padStart(2,'0') + ':' +
             String(now.getMinutes()).padStart(2,'0');

    var banner = document.getElementById('version-banner') || document.querySelector('.version-tag,#version,.version');
    if (banner) {
      banner.textContent = 'SOVERNX ' + next + ' ¬∑ Last updated: ' + ts;
    }
  } catch(e) { console.warn('version banner error', e); }
})();
</script>

<div class="iam-modal-backdrop" id="iam-backdrop">
  <div class="iam-modal" role="dialog" aria-modal="true">
    <h3>Sign in (Mock IAM)</h3>
    <div class="iam-row"><label>Email</label><input id="iam-email" type="email" placeholder="user@sovernx.demo"></div>
    <div class="iam-row"><label>Issuer (iss)</label><input id="iam-iss" value="https://id.sovernx.local/realms/sovernx"></div>
    <div class="iam-row"><label>Audience (aud)</label><input id="iam-aud" value="sovernx-spa"></div>
    <div class="iam-row"><label>Role</label>
      <select id="iam-role">
        <option>SPONSOR</option>
        <option>ECA</option>
        <option>BANK</option>
        <option>TREASURY</option>
        <option>AUDIT</option>
        <option>PLATFORM</option>
      </select>
    </div>
    <div class="iam-row"><label>Additional roles</label>
      <input id="iam-roles-extra" placeholder="comma separated e.g. REVIEWER,ESG" />
    </div>
    <div class="iam-row"><label>Public Key</label>
      <textarea id="iam-pubkey" rows="2">-----BEGIN MOCK PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwSOVERNXMOCKKEYzzzz
-----END MOCK PUBLIC KEY-----</textarea>
    </div>
    <div class="iam-note">
      Demo only ‚Äî no real signature verification. We pin <code>iss</code>/<code>aud</code> and use <code>roles</code> for UI gating.
    </div>
    <div class="iam-actions">
      <button class="iam-btn" id="iam-cancel">Cancel</button>
      <button class="iam-btn" id="iam-submit">Sign In</button>
    </div>
  </div>
</div>


<script>
(function(){
  'use strict';
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const nowIso = () => new Date().toISOString().replace('T',' ').slice(0,16);

  let token = null, claims = null;
  let cbOpen = true, cbFailures = 0, cbTimer = null;
  const cbThreshold = 3, cbCooldownMs = 6000;

  function setTopBar(){
    const userEl = $('#iam-user'), rolesEl = $('#iam-roles');
    const loginBtn = $('#iam-login-btn'), logoutBtn = $('#iam-logout-btn');
    if (claims){
      userEl.textContent = claims.email || '(user)';
      rolesEl.textContent = (claims.roles||[]).join(',');
      userEl.classList.remove('hidden'); rolesEl.classList.remove('hidden');
      loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden');
    } else {
      userEl.classList.add('hidden'); rolesEl.classList.add('hidden');
      loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden');
    }
  }
  function applyRoleGating(){
    const els = $$('[data-requires]');
    els.forEach(el => {
      const needs = (el.getAttribute('data-requires')||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
      const has = (claims && claims.roles) ? claims.roles.map(r=>r.toUpperCase()) : [];
      const ok = !needs.length || needs.some(r => has.includes(r));
      el.classList.toggle('hidden', !ok);
    });
  }
  
  function updateSignInVisibility(){
    const wrap = document.getElementById('app-wrap') || document.querySelector('.wrap');
    const pre = document.getElementById('prelogin-message');
    const nav = document.getElementById('main-nav');
    const signedIn = !!claims;
    if (wrap){ wrap.style.display = signedIn ? '' : 'none'; }
    if (nav){ nav.style.display = signedIn ? '' : 'none'; }
    if (pre){ pre.style.display = signedIn ? 'none' : ''; }
  }

  function showMainSection(key){
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(btn => {
      const active = btn.dataset.target === key;
      btn.classList.toggle('nav-tab-active', active);
    });
    const cards = document.querySelectorAll('.wrap .card');
    cards.forEach(card => {
      const secAttr = card.getAttribute('data-section') || '';
      if (!secAttr.trim()){
        card.style.display = '';
        return;
      }
      const parts = secAttr.split(/\s+/);
      const show = parts.includes(key);
      card.style.display = show ? '' : 'none';
    });
  }
function saveSession(){
    if (!claims || !token){ sessionStorage.removeItem('sxClaims'); sessionStorage.removeItem('sxToken'); return; }
    sessionStorage.setItem('sxClaims', JSON.stringify(claims));
    sessionStorage.setItem('sxToken', token);
  }
  function loadSession(){
    try{ const c=sessionStorage.getItem('sxClaims'); const t=sessionStorage.getItem('sxToken');
         if(c&&t){ claims=JSON.parse(c); token=t; } }catch(e){}
  }

  function base64url(obj){
    return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
  }
  function createMockJWT(payload){
    const header = { alg:'RS256', typ:'JWT', kid:'SOVERNX_DEMO' };
    const p1 = base64url(header), p2 = base64url(payload);
    const sig = 'MOCK_SIGNATURE';
    return p1+'.'+p2+'.'+sig;
  }
  function parseMockJWT(tok){
    const parts = tok.split('.'); if(parts.length!==3) throw new Error('Malformed token');
    const payload = JSON.parse(decodeURIComponent(escape(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')))));
    return payload;
  }

  const backdrop=$('#iam-backdrop');
  $('#iam-login-btn')?.addEventListener('click', ()=>{ backdrop.style.display='flex'; });
  $('#iam-cancel')?.addEventListener('click', ()=>{ backdrop.style.display='none'; });
  $('#iam-submit')?.addEventListener('click', ()=>{
    const email=($('#iam-email').value||'user@sovernx.demo').trim();
    const iss=($('#iam-iss').value||'https://id.sovernx.local/realms/sovernx').trim();
    const aud=($('#iam-aud').value||'sovernx-spa').trim();
    const role=$('#iam-role').value.trim();
    const extra=($('#iam-roles-extra').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const roles=Array.from(new Set([role, ...extra]));
    const nowSec=Math.floor(Date.now()/1000);
    const payload={ iss,aud,email,roles, iat:nowSec, exp:nowSec+900, sub:'demo-'+Math.random().toString(36).slice(2,8) };
    token=createMockJWT(payload);
    try{ claims=parseMockJWT(token); }catch(e){ claims=payload; }
    if (claims.iss!==iss || claims.aud!==aud){ alert('Issuer/Audience mismatch'); return; }
    backdrop.style.display='none'; setTopBar(); applyRoleGating(); syncIAMToRoleDropdown(claims); saveSession();
    auditLog({ type:'login', email, roles, at: nowIso(), ok:true }); updateSignInVisibility(); showMainSection('SIMULATION');
    
    // Highlight and scroll to user's available sections
    setTimeout(() => {
      // Clear any previous highlights
      $$('.step.user-section-highlight, .btn-step.user-section-highlight').forEach(el => {
        el.classList.remove('user-section-highlight');
      });
      
      // Find all steps and buttons that match the user's role
      const userRole = role;
      const userSteps = Array.from($$('.timeline .step')).filter(s => {
        const stepRole = s.getAttribute('data-role');
        return userRole === 'ALL' || userRole === stepRole || roles.includes(stepRole);
      });
      const userButtons = Array.from($$('.buttons .btn-step')).filter(b => {
        const btnRole = b.getAttribute('data-role');
        return userRole === 'ALL' || userRole === btnRole || roles.includes(btnRole);
      });
      
      // Apply highlight class to user's sections
      userSteps.forEach(s => {
        s.classList.add('user-section-highlight');
      });
      userButtons.forEach(b => {
        b.classList.add('user-section-highlight');
      });
      
      // Show success notification
      const notifMsg = `‚úì Welcome ${email}! Your available sections are highlighted in gold.`;
      console.log(notifMsg);
      
      // Scroll to first available button
      if(userButtons.length > 0){
        const firstBtn = userButtons[0];
        firstBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else if(userSteps.length > 0){
        const firstStep = userSteps[0];
        firstStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 150);
  });
  $('#iam-logout-btn')?.addEventListener('click', ()=>{
    auditLog({ type:'logout', email:(claims&&claims.email)||'', at: nowIso(), ok:true });
    token=null; claims=null; saveSession(); setTopBar(); applyRoleGating();
    // Reset role dropdown to ALL when logging out
    const roleSelect = $('#role');
    if(roleSelect){ roleSelect.value = 'ALL'; }
    applyRole(); // Reapply role filtering after logout
    updateSignInVisibility(); showMainSection('DASHBOARDS');
    
    // Remove highlights from user's sections
    $$('.step.user-section-highlight, .btn-step.user-section-highlight').forEach(el => {
      el.classList.remove('user-section-highlight');
    });
  });

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function openBreaker(){ cbOpen=true; cbFailures=0; if(cbTimer){clearTimeout(cbTimer); cbTimer=null;} }
  function tripBreaker(){ cbOpen=false; if(cbTimer){clearTimeout(cbTimer);} cbTimer=setTimeout(()=>openBreaker(), 6000); }

  async function sxFetch(url, opts={}){
    const API_BASE = window.SX_API_BASE || 'offline://gateway';
    const full = url.startsWith('http') ? url : (API_BASE + url);
    const method=(opts.method||'GET').toUpperCase();
    const body=opts.body;
    if (full.startsWith('offline://')){
      await sleep(250);
      const mock={ ok:true, method, url, user:(claims&&claims.email)||'guest', roles:(claims&&claims.roles)||[], ts: nowIso() };
      auditLog({ type:'fetch', url, method, outcome:'stubbed', user: mock.user, roles: mock.roles, at: mock.ts, ok:true });
      return { ok:true, status:200, json: async()=>mock };
    }
    if(!cbOpen){ auditLog({ type:'fetch', url, method, outcome:'breaker_open', at: nowIso(), ok:false }); throw new Error('Circuit breaker open'); }
    const headers=Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    if(token) headers['Authorization']='Bearer '+token;
    const maxRetries=(opts.retries!=null)?opts.retries:2;
    let attempt=0;
    while(true){
      try{
        const resp=await fetch(full,{method,headers,body});
        if(!resp.ok){
          cbFailures++; auditLog({ type:'fetch', url, method, status:resp.status, at: nowIso(), ok:false });
          if(cbFailures>=cbThreshold) tripBreaker();
          if(attempt<maxRetries && resp.status>=500){ attempt++; await sleep(200*attempt); continue; }
          return resp;
        } else {
          cbFailures=0; auditLog({ type:'fetch', url, method, status:resp.status, at: nowIso(), ok:true });
          return resp;
        }
      }catch(e){
        cbFailures++; auditLog({ type:'fetch', url, method, error:e.message, at: nowIso(), ok:false });
        if(cbFailures>=cbThreshold) tripBreaker();
        if(attempt<maxRetries){ attempt++; await sleep(200*attempt); continue; }
        throw e;
      }
    }
  }

  window.auditEvents = window.auditEvents || [];
  window.auditLog = function(evt){
    try {
      window.auditEvents.push(evt);
      if (typeof window.addLedger==='function') window.addLedger(evt);
      else if (typeof window.addAuditEvent==='function') window.addAuditEvent(evt);
    } catch(e){}
  };

  loadSession(); setTopBar(); applyRoleGating(); updateSignInVisibility(); showMainSection('SIMULATION');
  window.sxFetch=sxFetch; window.sxClaims=()=>claims; window.sxToken=()=>token;

  
  document.addEventListener('click', function(ev){
    const tab = ev.target.closest && ev.target.closest('.nav-tab');
    if(!tab) return;
    ev.preventDefault();
    const key = tab.getAttribute('data-target');
    if(key) showMainSection(key);
  });

document.addEventListener('click', function(ev){
    const btn=ev.target.closest && ev.target.closest('[data-fetch]'); if(!btn) return;
    const url=btn.getAttribute('data-fetch'); const method=btn.getAttribute('data-method')||'GET';
    const body=btn.getAttribute('data-body'); sxFetch(url,{method,body})
      .then(async resp=>{ const js=resp.json?await resp.json():{}; if (typeof window.notify==='function') window.notify('Fetch OK: '+(js&&js.url||url)); })
      .catch(err=>{ if(typeof window.notify==='function') window.notify('Fetch failed: '+err.message); });
  }, {passive:true});

  (function(){
    const v=document.getElementById('iam-version'); if(!v) return;
    const ts=new Date(); const stamp=ts.getFullYear()+'-'+String(ts.getMonth()+1).padStart(2,'0')+'-'+String(ts.getDate()).padStart(2,'0')+' '+String(ts.getHours()).padStart(2,'0')+':'+String(ts.getMinutes()).padStart(2,'0');
    v.textContent='SOVERNX v4.1.2 ¬∑ '+stamp;
  })();
})();
</script>



<script>
/* === SOVERNX Comfort Pack (light demo hardening) === */
(function(){
  try{
    // 1) Demo licence gate
    var ACCEPT_KEY='sx_demo_accepted_v1';
    var accepted=localStorage.getItem(ACCEPT_KEY)==='yes';
    if(!accepted){ document.body.classList.add('sx-demo-locked'); }
    else { document.body.classList.remove('sx-demo-locked'); try{ var bd0=document.getElementById('sx-demo-license-backdrop'); if(bd0) bd0.style.display='none'; }catch(e){} }

    var cb=document.getElementById('sx-demo-accept');
    var btn=document.getElementById('sx-demo-continue');
    var view=document.getElementById('sx-demo-view');
    var backdrop=document.getElementById('sx-demo-license-backdrop');

    if(cb && btn){
      function _sxSyncAccept(){
        try{
          var ok = !!cb.checked;
          // toggle disabled in the most compatible way (iPad/WebKit safe)
          btn.disabled = !ok;
          if(ok){
            btn.removeAttribute('disabled');
            btn.setAttribute('aria-disabled','false');
            btn.classList.remove('is-disabled');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
          }else{
            btn.setAttribute('disabled','disabled');
            btn.setAttribute('aria-disabled','true');
            btn.classList.add('is-disabled');
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '.55';
          }
        }catch(e){}
      }catch(e){} }
      // iPad/WebKit can be finicky with 'change' in some embed contexts; listen broadly.
      ['change','input','click','pointerdown','pointerup','touchstart','touchend'].forEach(function(evt){
        try{ cb.addEventListener(evt, _sxSyncAccept, {passive:true}); }catch(e){ try{ cb.addEventListener(evt, _sxSyncAccept); }catch(_e){} }
      });
      _sxSyncAccept();
      // WebKit/iPad sometimes fails to dispatch change events consistently in embedded contexts.
      // Poll briefly to ensure the Continue button reflects the checkbox state.
      (function(){
        var tries=0;
        var t=setInterval(function(){
          tries++;
          try{ _sxSyncAccept(); }catch(e){}
          if(tries>=25 || !btn.disabled){ clearInterval(t); }
        }, 200);
      })();
      btn.addEventListener('click', function(){
        if(!cb.checked){
          // guard: user must acknowledge terms
          try{ alert('Please acknowledge the Demo Licence terms to continue.'); }catch(e){}
          return;
        }
        
        localStorage.setItem(ACCEPT_KEY,'yes');
        try{ if(typeof auditLog==='function') auditLog({type:'demo_accept', at:(new Date()).toISOString(), ok:true}); }catch(e){}
        document.body.classList.remove('sx-demo-locked');
        if(backdrop) backdrop.style.display='none';
        enableLogin();
        refreshWatermark();
      });
    }
    if(view){
      view.addEventListener('click', function(){
        alert('Demo Licence Summary:

- Evaluation use only (no commercial use).
- No copying/redistribution.
- Simulation only; no live funds.
- Access logged locally.');
      });
    }

    // 2) IAM login gate (disable login until licence accepted)
    function enableLogin(){
      var loginBtn=document.getElementById('iam-login-btn');
      if(!loginBtn) return;
      var ok = localStorage.getItem(ACCEPT_KEY)==='yes';
      loginBtn.disabled = !ok;
      loginBtn.title = ok ? '' : 'Accept the Demo Licence to continue';
    }
    enableLogin();

    // 3) Auth gate: keep core sections read-only until IAM login sets sessionStorage sxToken
    function isAuthed(){ return !!sessionStorage.getItem('sxToken'); }
    function setAuthGate(){
      if(!isAuthed()) document.body.classList.add('sx-auth-locked');
      else document.body.classList.remove('sx-auth-locked');
    }
    setAuthGate();

    // Hook into existing auditLog (if present) to also keep a local access log
    var LOG_KEY='sx_demo_access_log_v1';
    function pushAccess(ev){
      try{
        var arr=JSON.parse(localStorage.getItem(LOG_KEY)||'[]');
        arr.push(ev);
        if(arr.length>500) arr=arr.slice(arr.length-500);
        localStorage.setItem(LOG_KEY, JSON.stringify(arr));
      }catch(e){}
    }
    if(typeof auditLog==='function' && !auditLog.__sxWrapped){
      var _audit=auditLog;
      var wrapped=function(ev){
        try{ pushAccess({t:(new Date()).toISOString(), ev:ev}); }catch(e){}
        return _audit(ev);
      };
      wrapped.__sxWrapped=true;
      // preserve refs
      for(var k in _audit){ try{ wrapped[k]=_audit[k]; }catch(e){} }
      window.auditLog = wrapped;
    }

    // Detect login/logout by watching sessionStorage token changes
    window.addEventListener('storage', function(e){ if(e.key==='sxToken'){ setAuthGate(); refreshWatermark(); } });

    // Also hook IAM submit/logout buttons to refresh gates
    var iamSubmit=document.getElementById('iam-submit');
    var iamLogout=document.getElementById('iam-logout-btn');
    if(iamSubmit){ iamSubmit.addEventListener('click', function(){ setTimeout(function(){ setAuthGate(); refreshWatermark(); }, 50); }); }
    if(iamLogout){ iamLogout.addEventListener('click', function(){ setTimeout(function(){ setAuthGate(); refreshWatermark(); }, 50); }); }

    // 4) Watermark (viewer + session)
    var sid = (function(){
      try{ var s=sessionStorage.getItem('sx_demo_sid'); if(s) return s; }catch(e){}
      var s='SX-'+Math.random().toString(36).slice(2,8).toUpperCase();
      try{ sessionStorage.setItem('sx_demo_sid', s); }catch(e){}
      return s;
    })();
    function refreshWatermark(){
      var wm=document.getElementById('sx-watermark');
      if(!wm) return;
      var now=new Date();
      var roleEl=document.getElementById('iam-roles');
      var userEl=document.getElementById('iam-user');
      var rolesTxt=roleEl && !roleEl.classList.contains('hidden') ? roleEl.textContent : 'Not signed in';
      var userTxt=userEl && !userEl.classList.contains('hidden') ? userEl.textContent : '';
      wm.innerHTML = '<b>DEMO</b> ¬∑ '+sid+'<br>'+now.toISOString().replace('T',' ').replace('Z',' UTC')+'<br>'+ (userTxt?('<b>'+escapeHtml(userTxt)+'</b><br>'):'') + escapeHtml(rolesTxt);
      wm.classList.remove('hidden');
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]);}); }
    refreshWatermark();
    setInterval(refreshWatermark, 60000);

  }catch(e){ console.warn('ComfortPack init error', e); }
})();
</script>
</body>
</html>
